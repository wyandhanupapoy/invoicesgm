<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Sistem Penjualan dan Pembelian" />
    <meta name="author" content="Sistem Akuntansi v4.6 - Final" />
    <title>Sistem Akuntansi v4.6 (Final)</title>
    <style>
      :root {
        --primary: #003087;
        --primary-dark: #002060;
        --secondary: #d32f2f;
        --success: #2e7d32;
        --warning: #f57c00;
        --danger: #c62828;
        --info: #0277bd;
        --dark: #212121;
        --light: #fafafa;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --border: #e0e0e0;
        --text: var(--dark);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: #f4f6f8;
        color: var(--text);
        min-height: 100vh;
        padding: 15px;
        font-size: 15px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--light);
        border-radius: 8px;
        padding: 25px;
        box-shadow: var(--shadow);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        text-align: left;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
      }
      .header img {
        max-height: 60px;
      }
      .header h1 {
        color: var(--primary);
        font-size: 1.9rem;
        font-weight: 600;
        margin: 0;
      }
      .header .subtitle {
        color: #616161;
        font-size: 1rem;
        margin: 0;
      }
      .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--border);
      }
      .nav-tab {
        padding: 12px 25px;
        background: var(--light);
        border: 1px solid var(--border);
        border-bottom: none;
        cursor: pointer;
        font-weight: 500;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        margin-right: 5px;
        transition: all 0.2s;
        color: var(--text);
        margin-bottom: -1px;
      }
      .nav-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .nav-tab:hover:not(.active) {
        background: #e9ecef;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .form-section {
        background: #fdfdfd;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }
      .form-section-title {
        color: var(--primary);
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .form-group label {
        color: var(--dark);
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.95rem;
        background: #ffffff;
        color: var(--dark);
        transition: border-color 0.2s;
        font-family: inherit;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.15);
      }
      .form-group input[readonly] {
        background: #e9ecef;
        cursor: not-allowed;
        font-weight: 500;
      }
      .form-group input:invalid {
        border-color: var(--danger);
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-warning {
        background: var(--warning);
        color: white;
      }
      .btn-info {
        background: var(--info);
        color: white;
      }
      .btn-sm {
        padding: 5px 10px;
        font-size: 0.8rem;
      }
      .actions-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }
      .table-container {
        margin-top: 20px;
        overflow-x: auto;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .data-table th,
      .data-table td {
        padding: 10px 12px;
        border: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }
      .data-table thead th {
        background: #f4f6f8;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .data-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .data-table td.text-right,
      .data-table th.text-right {
        text-align: right;
      }
      .data-table .action-cell {
        text-align: center;
        white-space: nowrap;
      }
      .data-table .action-cell .btn {
        margin: 2px;
      }
      .summary-section {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
      }
      .summary-grid {
        width: 100%;
        max-width: 450px;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
      }
      .summary-grid label {
        font-weight: 600;
        text-align: right;
        padding-right: 10px;
        align-self: center;
      }
      .summary-grid .total-amount-display {
        grid-column: 2 / 3;
      }
      .total-amount-display {
        font-size: 1.1rem;
        font-weight: bold;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
        text-align: right;
      }
      .notification {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        border: 1px solid transparent;
        display: none;
        animation: fadeIn 0.5s;
      }
      .notification.success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .notification.error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .filterable-dropdown {
        position: relative;
      }
      .dropdown-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid var(--border);
        border-top: none;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .dropdown-option {
        padding: 10px;
        cursor: pointer;
      }
      .dropdown-option:hover {
        background-color: #f0f0f0;
      }
      .dropdown-option small {
        color: #888;
        display: block;
      }
      .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .stat-card-title {
        font-size: 1rem;
        color: #616161;
        margin-bottom: 10px;
      }
      .stat-card-value {
        font-size: 2rem;
        font-weight: 600;
        color: var(--primary);
        word-wrap: break-word;
      }
      .stat-card-value.profit {
        color: var(--success);
      }
      .stat-card-value.loss {
        color: var(--danger);
      }
      .history-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
      }
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #print-area {
        display: none;
      }
      @media print {
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        body,
        .printable-content {
          margin: 0;
          padding: 0;
          font-family: "Courier New", Courier, monospace;
          color: #000;
          font-size: 10pt;
        }
        body > *:not(#print-area) {
          display: none !important;
        }
        #print-area {
          display: block !important;
        }
        .page {
          page-break-after: always;
          width: 210mm;
          min-height: 148mm;
          padding: 10mm;
        }
        .page:last-child {
          page-break-after: avoid;
        }
        .print-header {
          display: flex;
          align-items: flex-start;
          justify-content: space-between;
          margin-bottom: 5mm;
          border-bottom: 2px solid #000;
          padding-bottom: 5mm;
        }
        .print-header .company-info {
          text-align: left;
        }
        .print-header .logo {
          max-height: 50px;
          max-width: 150px;
        }
        .print-header h3 {
          font-size: 14pt;
          margin: 0;
          color: #000;
        }
        .print-header p {
          font-size: 9pt;
          margin: 2px 0;
          color: #000;
        }
        .print-section {
          border: 1px solid #000;
          padding: 5mm;
          margin-top: 5mm;
        }
        .print-section.kwitansi {
          border-style: dashed;
        }
        .print-section h4 {
          text-align: center;
          margin-bottom: 5mm;
          text-decoration: underline;
          font-size: 12pt;
        }
        .meta-table {
          width: 100%;
          margin-bottom: 5mm;
          font-size: 10pt;
        }
        .meta-table td {
          vertical-align: top;
          padding: 1px 2px;
        }
        .items-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 5mm;
          font-size: 10pt;
        }
        .items-table th,
        .items-table td {
          border: 1px solid #000;
          padding: 5px;
          text-align: left;
        }
        .items-table th {
          background-color: #eee !important;
        }
        .summary-table {
          width: 50%;
          float: right;
          margin-top: 5mm;
          border-collapse: collapse;
          font-size: 10pt;
        }
        .summary-table td {
          padding: 2px 5px;
        }
        .kwitansi-box {
          border: 1px solid #000;
          padding: 5mm;
          margin: 5mm 0;
        }
        .kwitansi-box .terbilang {
          font-style: italic;
          font-weight: bold;
        }
        .print-footer {
          margin-top: 10mm;
        }
        .print-signatures {
          display: flex;
          justify-content: space-around;
          text-align: center;
          width: 100%;
          margin-top: 15mm;
        }
        .print-signatures > div {
          width: 30%;
        }
        .signature-space {
          height: 60px;
        }
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="container">
      <div class="header">
        <img
          src="logo.png"
          id="header-logo"
          alt="Logo Perusahaan"
          onerror="this.onerror=null; this.src='https://via.placeholder.com/150x50.png?text=Logo';"
        />
        <div>
          <h1 id="header-title">Sistem Akuntansi Terpadu</h1>
          <p class="subtitle" id="header-tagline">
            Pencatatan Penjualan, Pembelian, dan Surat Jalan
          </p>
        </div>
      </div>

      <div class="nav-tabs" role="tablist">
        <button class="nav-tab active" data-tab="dashboard" role="tab">
          Dashboard
        </button>
        <button class="nav-tab" data-tab="penjualan" role="tab">
          Penjualan
        </button>
        <button class="nav-tab" data-tab="pembelian" role="tab">
          Pembelian
        </button>
        <button class="nav-tab" data-tab="suratJalan" role="tab">
          Surat Jalan
        </button>
        <button class="nav-tab" data-tab="pengaturan" role="tab">
          Pengaturan
        </button>
      </div>

      <div id="notification-area" class="notification"></div>

      <div id="dashboard" class="tab-content active" role="tabpanel"></div>
      <div id="penjualan" class="tab-content" role="tabpanel"></div>
      <div id="pembelian" class="tab-content" role="tabpanel"></div>
      <div id="suratJalan" class="tab-content" role="tabpanel"></div>

      <div id="pengaturan" class="tab-content" role="tabpanel">
        <div class="form-section">
          <h3 class="form-section-title">Pengaturan Informasi Perusahaan</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="config-namaPerusahaan">Nama Perusahaan</label
              ><input type="text" id="config-namaPerusahaan" required />
            </div>
            <div class="form-group">
              <label for="config-alamatPerusahaan">Alamat Perusahaan</label
              ><input type="text" id="config-alamatPerusahaan" required />
            </div>
            <div class="form-group">
              <label for="config-kontak">Kontak</label
              ><input type="text" id="config-kontak" required />
            </div>
            <div class="form-group">
              <label for="config-rekening">Info Rekening Bank</label
      -            ><input type="text" id="config-rekening" />
+             ><input type="text" id="config-rekening" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1">
              <label for="config-logoUrl"
                >URL Logo (Ganti dengan link logo Anda)</label
              ><input type="url" id="config-logoUrl" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1">
              <label for="config-tagline">Tagline/Deskripsi (untuk SJ)</label
              ><textarea id="config-tagline" rows="2"></textarea>
            </div>
          </div>
          <div class="actions-group">
            <button type="button" id="saveConfigBtn" class="btn btn-primary">
              Simpan Informasi
            </button>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Manajemen Data Barang</h3>
          <div id="add-master-item-form"></div>
          <hr style="margin: 20px 0" />
          <p style="margin-bottom: 15px; font-weight: bold">
            Status: <span id="master-item-count">0</span> barang termuat.
          </p>
          <div class="form-group">
            <label for="masterItemJson"
              >Edit Massal Data Master (Format JSON)</label
            >
            <textarea
              id="masterItemJson"
              rows="10"
              placeholder="Tempel (paste) data JSON dari skrip Python di sini..."
            ></textarea>
          </div>
          <div class="actions-group">
            <button
              type="button"
              id="saveMasterItemsBtn"
              class="btn btn-primary"
            >
              Simpan dari JSON
            </button>
            <button type="button" id="exportCsvBtn" class="btn btn-success">
              Export CSV
            </button>
            <button type="button" id="importCsvBtn" class="btn btn-warning">
              Import CSV
            </button>
            <input
              type="file"
              id="csvFileInput"
              style="display: none"
              accept=".csv"
            />
            <button
              type="button"
              id="clearMasterItemsBtn"
              class="btn btn-danger"
            >
              Hapus Semua Barang
            </button>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Backup & Restore</h3>
          <p style="margin-bottom: 15px">
            Simpan semua data transaksi dan data barang ke dalam satu file JSON,
            atau pulihkan dari file cadangan.
          </p>
          <div class="actions-group">
            <button type="button" id="backupDataBtn" class="btn btn-success">
              Backup Semua Data
            </button>
            <button type="button" id="restoreDataBtn" class="btn btn-warning">
              Restore Data
            </button>
            <input
              type="file"
              id="restoreFileInput"
              style="display: none"
            	 accept=".json"
            />
          </div>
        </div>
      </div>
    </div>

    <div id="print-area"></div>

    <script>
        	/**
        	 * Utility functions for common operations
        	 */
        	const Utils = {
        		formatRupiahInput(input) {
        		let value = input.value.replace(/[^0-9]/g, '');
        		if (value === '') {
        			input.value = '';
        			return;
        		}
        		const number = parseInt(value, 10);
        		if (isNaN(number)) {
        			input.value = '';
        			return;
        		}
        		input.value = new Intl.NumberFormat('id-ID').format(number);
        		},
        		debounce(func, wait) {
        			let timeout;
        			return function(...args) {
        				const context = this;
        				clearTimeout(timeout);
        				timeout = setTimeout(() => func.apply(context, args), wait);
        			};
        		},
        		validateInput: (value, type) => {
        			switch(type) {
        				case 'required': return !!value.trim();
        				case 'number': return !isNaN(value) && value >= 0;
        				case 'url': return /^https?:\/\/[^\s/$.?#].[^\s]*$/.test(value);
        				case 'phone': return /^\+?[\d\s-]{8,}$/.test(value);
        				default: return true;
        			}
        		},
        		logError: (message, error) => {
        			console.error(`[SistemAkuntansi] ${message}`, error);
        		}
        	};

        	/**
        	 * Main accounting system class
        	 */
        	class SistemAkuntansi {
        		constructor() {
        			this.STORAGE_KEY = "sistemAkuntansiData_v4.6"; // Version bump
        			this.DRAFT_KEY = "sistemAkuntansiDraft_v4.6";
        			this.data = null;
        			this.activeDropdown = null;
        			this.tempItems = { sale: [], purchase: [], delivery: [] };
        			this.draftForms = { sale: null, purchase: null, delivery: null };
        			this.isLoading = false;

        			this.init();
        		}

        		async init() {
				try {
					console.log('Starting init...');
					this.showLoading(true);
					console.log('Loading data...');
					await this.loadData();
					console.log('Building DOM...');
					this.buildDOM();
					console.log('Binding global events...');
					this.bindGlobalEvents();
					console.log('Updating UI...');
					await this.updateAllUI();
					console.log('Loading drafts...');
					this.loadDrafts();
				} catch (error) {
					Utils.logError('Initialization failed', error);
					this.showNotification('Gagal memuat sistem: ' + error.message, false);
				} finally {
					this.showLoading(false);
				}
			}

        		showLoading(show) {
        			this.isLoading = show;
        			document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        		}

        		buildDOM() {
        			['sale', 'purchase', 'delivery'].forEach(type => {
        				const container = document.getElementById(type === 'sale' ? 'penjualan' : type === 'purchase' ? 'pembelian' : 'suratJalan');
        				if (container) container.innerHTML = this.generateFormHTML(type) + this.generateHistoryHTML(type);
        			});
        			const dashboardContainer = document.getElementById('dashboard');
        			if(dashboardContainer) dashboardContainer.innerHTML = this.generateDashboardHTML();

        			const addItemContainer = document.getElementById('add-master-item-form');
        			if(addItemContainer) addItemContainer.innerHTML = this.generateAddItemFormHTML();
        		}

        		generateFormHTML(type) {
				const isTransaction = type === 'sale' || type === 'purchase';
				const title = type === 'sale' ? 'Penjualan' : type === 'purchase' ? 'Pembelian' : 'Surat Jalan';
				const partyLabel = type === 'sale' ? 'Customer' : type === 'purchase' ? 'Pemasok' : 'Penerima';
				const partyType = type === 'sale' ? 'customer' : type === 'purchase' ? 'pemasok' : 'recipient';

				let formFields = `
        			<div class="form-group">
        				<label for="transNo-${type}">No. Transaksi</label>
        				<input type="text" id="transNo-${type}" readonly value="${this.generateId(type)}">
        			</div>
        			<div class="form-group">
        				<label for="${isTransaction ? 'invoiceDate' : 'deliveryDate'}-${type}">Tanggal</label>
        				<input type="date" id="${isTransaction ? 'invoiceDate' : 'deliveryDate'}-${type}" required value="${new Date().toISOString().slice(0, 10)}">
        			</div>
        			<div class="form-group">
        				<label for="${partyType}Name-${type}">Nama ${partyLabel}</label>
        				<input type="text" id="${partyType}Name-${type}" required>
        			</div>
        			<div class="form-group">
        				<label for="${partyType}Address-${type}">Alamat ${partyLabel}</label>
        				<input type="text" id="${partyType}Address-${type}">
        			</div>
        			<div class="form-group">
        				<label for="${partyType}Phone-${type}">Telepon ${partyLabel}</label>
        				<input type="text" id="${partyType}Phone-${type}" pattern="\\+?[\\d\\s-]{8,}">
        			</div>
        			<div class="form-group">
        				<label for="vehicleNo-${type}">No. Kendaraan</label>
        				<input type="text" id="vehicleNo-${type}">
        			</div>
        		`;

				if (isTransaction) {
					formFields += `
        					${type === 'sale' ? `
        						<div class="form-group">
        							<label for="ref-${type}">Ref</label>
        							<input type="text" id="ref-${type}">
        						</div>
        					` : ''}
        					<div class="form-group">
        						<label for="paymentMethod-${type}">Metode Pembayaran</label>
        						<select id="paymentMethod-${type}">
        							<option value="Transfer">Transfer</option>
        							<option value="Tunai">Tunai</option>
        							<option value="Kredit">Kredit</option>
        						</select>
        					</div>
        			`;
				}

				const itemFields = `
        			<div class="form-section">
        				<h3 class="form-section-title">Tambah Barang</h3>
        				<div class="form-grid">
        					<div class="form-group filterable-dropdown">
        						<label for="item-selector-${type}">Cari Barang (Nama/Kode)</label>
        						<input type="text" id="item-selector-${type}" autocomplete="off">
        						<div class="dropdown-options" id="dropdown-options-${type}"></div>
        					</div>
        					<div class="form-group">
        						<label for="itemCode-${type}">Kode Barang</label>
        						<input type="text" id="itemCode-${type}" readonly>
        					</div>
        					<div class="form-group">
        						<label for="itemQty-${type}">Jumlah</label>
        						<input type="number" id="itemQty-${type}" min="0" step="0.01" required>
        					</div>
        					<div class="form-group">
        						<label for="itemUnit-${type}">Satuan</label>
        						<input type="text" id="itemUnit-${type}">
        					</div>
        					${isTransaction ? `
        						<div class="form-group">
        							<label for="itemPrice-${type}">Harga Satuan (Rp)</label>
        							<input type="text" id="itemPrice-${type}" class="rupiah-input" required>
        						</div>
        					` : ''}
        					<div class="form-group">
        						<button type="button" id="addItemBtn-${type}" class="btn btn-primary">Tambah Barang</button>
        					</div>
        				</div>
        			</div>
        		`;

				const tableHeaders = isTransaction
					? `
        				<th>No</th>
        				<th>Kode</th>
        				<th>Nama Barang</th>
        				<th class="text-right">Jumlah</th>
        				<th>Satuan</th>
        				<th class="text-right">Harga Satuan</th>
        				<th class="text-right">Total</th>
        				<th class="action-cell">Aksi</th>
        			`
					: `
        				<th>No</th>
        				<th>Kode</th>
        				<th>Nama Barang</th>
        				<th class="text-right">Jumlah</th>
        				<th>Satuan</th>
        				<th class="action-cell">Aksi</th>
        			`;

				const summarySection = isTransaction
					? `
        				<div class="summary-section">
        					<div class="summary-grid">
        						<label>Subtotal:</label>
        						<div class="total-amount-display" id="subtotal-${type}">0</div>
        						<label>Diskon (Rp):</label>
        						<input type="text" id="discount-${type}" class="rupiah-input" value="0">
        						<label>Ongkos Kirim (Rp):</label>
        						<input type="text" id="shippingCost-${type}" class="rupiah-input" value="0">
        						<label>PPN 11%:</label>
        						<div class="form-group">
        							<label><input type="checkbox" id="includePpn-${type}"> Include PPN</label>
        							<div class="total-amount-display" id="ppn-${type}">0</div>
        						</div>
        						<label>Grand Total:</label>
        						<div class="total-amount-display" id="grandTotal-${type}">0</div>
        					</div>
        				</div>
        			`
					: '';

				return `
        			<div class="form-section">
        				<h3 class="form-section-title">Form ${title}</h3>
        				<form id="${type}Form">
        					<div class="form-grid">
        						${formFields}
        					</div>
        					${itemFields}
        					<div class="table-container">
        						<table class="data-table" id="temp-items-table-${type}">
        							<thead><tr>${tableHeaders}</tr></thead>
        							<tbody></tbody>
        						</table>
        					</div>
        					${summarySection}
        					<div class="form-group">
        						<label for="notes-${type}">Catatan</label>
        						<textarea id="notes-${type}" rows="3"></textarea>
        					</div>
        					<div class="actions-group">
        						<button type="submit" class="btn btn-success">Simpan Transaksi</button>
        						<button type="button" class="btn btn-warning" onclick="app.resetForm('${type}')">Reset Form</button>
        					</div>
        				</form>
        			</div>
        		`;
			}

        		bindGlobalEvents() {
				document.addEventListener('click', (e) => {
					const filterableDropdown = e.target.closest('.filterable-dropdown');
					const dropdownOptions = e.target.closest('.dropdown-options');
					if (!filterableDropdown && !dropdownOptions) {
						this.closeAllDropdowns();
					}
				});

				['sale', 'purchase', 'delivery'].forEach(type => {
					const filters = document.getElementById(`history-filters-${type}`);
					if (filters) {
						filters.addEventListener('input', Utils.debounce(() => {
							const dataKey = type === 'sale' ? 'penjualan' : type === 'purchase' ? 'pembelian' : 'suratJalan';
							this.renderHistoryTable(dataKey, `${type}-history-table`);
						}, 300));
					}
				});

        			['sale', 'purchase', 'delivery'].forEach(type => this.bindFormEvents(type));

        			document.getElementById("saveMasterItemsBtn").addEventListener("click", () => this.saveMasterItemsFromTextarea());
        			document.getElementById("clearMasterItemsBtn").addEventListener("click", () => this.clearMasterItems());
        			document.getElementById("saveConfigBtn").addEventListener("click", () => this.saveConfig());
        			document.getElementById("backupDataBtn").addEventListener("click", () => this.backupData());
        			document.getElementById("restoreDataBtn").addEventListener("click", () => document.getElementById("restoreFileInput").click());
        			document.getElementById("restoreFileInput").addEventListener("change", (e) => this.restoreData(e));
        			document.getElementById("exportCsvBtn").addEventListener("click", () => this.exportMasterItemsToCsv());
        			document.getElementById("importCsvBtn").addEventListener("click", () => document.getElementById("csvFileInput").click());
        			document.getElementById("csvFileInput").addEventListener("change", (e) => this.importMasterItemsFromCsv(e));

        			const addMasterItemForm = document.getElementById('add-master-item-form-element');
        			if (addMasterItemForm) {
        				addMasterItemForm.addEventListener('submit', (e) => {
        					e.preventDefault();
        					this.addNewMasterItem();
        				});
        			}

        			document.addEventListener('click', (e) => {
        				if (!e.target.closest('.filterable-dropdown')) {
        					this.closeAllDropdowns();
        				}
        			});

        			const dashboardFilters = document.getElementById('dashboard-filters');
        			if (dashboardFilters) {
        				dashboardFilters.addEventListener('input', Utils.debounce(this.renderDashboard.bind(this), 300));
        			}
        		}

        		bindFormEvents(type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				form.addEventListener('submit', (e) => {
					e.preventDefault();
					this.saveTransaction(type);
				});

				form.addEventListener('input', Utils.debounce(() => this.saveDraft(type), 1000));

				const itemSelector = form.querySelector(`#item-selector-${type}`);
				const dropdownOptions = form.querySelector(`#dropdown-options-${type}`);

				itemSelector.addEventListener('input', Utils.debounce(() => this.handleItemInput(type), 300));
				itemSelector.addEventListener('focus', () => this.filterDropdown(type, true));
				dropdownOptions.addEventListener('click', (e) => {
					const option = e.target.closest('.dropdown-option');
					if (option) {
						this.selectItemFromDropdown(option.dataset.code, type);
					}
				});

				form.querySelector(`#addItemBtn-${type}`).addEventListener('click', () => this.addItemToTempList(type));

				const tempItemsTable = form.querySelector(`#temp-items-table-${type}`);
				if(tempItemsTable) {
					tempItemsTable.addEventListener('click', (e) => {
						if (e.target.classList.contains('delete-temp-item-btn')) {
							this.deleteItemFromTempList(parseInt(e.target.dataset.id, 10), type);
						}
					});
				}

				if (type !== 'delivery') {
					['shippingCost', 'discount'].forEach(id => {
						const el = form.querySelector(`#${id}-${type}`);
						if(el) el.addEventListener('input', () => this.calculateTotals(type));
					});
					const ppnCheckbox = form.querySelector(`#includePpn-${type}`);
					if(ppnCheckbox) ppnCheckbox.addEventListener('change', () => this.calculateTotals(type));
					
					['itemPrice', 'shippingCost', 'discount'].forEach(id => {
						const input = form.querySelector(`#${id}-${type}`);
						if (input) {
							input.addEventListener('input', (e) => Utils.formatRupiahInput(e.target));
							input.addEventListener('blur', () => this.calculateTotals(type));
						}
					});
				}

				// Add formatRupiahInput for itemPrice specifically
				const itemPriceInput = form.querySelector(`#itemPrice-${type}`);
				if (itemPriceInput) {
					itemPriceInput.addEventListener('input', (e) => Utils.formatRupiahInput(e.target));
				}
			}

			selectItemFromDropdown(code, type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				const item = this.data.masterItems.find(i => i.code === code);
				if (!item) return;

				form.querySelector(`#item-selector-${type}`).value = item.name;
				form.querySelector(`#itemCode-${type}`).value = item.code;
				form.querySelector(`#itemUnit-${type}`).value = item.unit || '';
				if (type !== 'delivery') {
					form.querySelector(`#itemPrice-${type}`).value = this.formatNumber(item.price || 0);
				}
				this.closeAllDropdowns();
			}

			// ***FIXED***: The duplicated event listener code that was here has been removed.

			formatCurrency(value, withSymbol = true) {
				const options = {
					style: 'currency',
					currency: 'IDR',
					minimumFractionDigits: 0,
					maximumFractionDigits: 0
				};
				if (!withSymbol) {
					delete options.style;
					delete options.currency;
				}
				return new Intl.NumberFormat('id-ID', options).format(value || 0);
			}
			
			formatNumber(value) {
				return new Intl.NumberFormat('id-ID').format(value || 0);
			}

        		addItemToTempList(type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				const itemCode = form.querySelector(`#itemCode-${type}`).value;
				const qty = parseFloat(form.querySelector(`#itemQty-${type}`).value) || 0;
				const price = type !== 'delivery' ? parseInt(form.querySelector(`#itemPrice-${type}`).value.replace(/[^0-9]/g, ''), 10) || 0 : 0;
				const unit = form.querySelector(`#itemUnit-${type}`).value;

				// Validate item code
				const item = this.data.masterItems.find(i => i.code === itemCode);
				if (!item) {
					this.showNotification('Kode barang tidak ditemukan di master barang.', false);
					return;
				}

				// Validate quantity
				if (qty <= 0) {
					this.showNotification('Jumlah barang harus lebih dari 0.', false);
					return;
				}

				const newItem = {
					id: Date.now(),
					code: itemCode,
					name: item.name,
					qty,
					unit: unit || item.unit || '-',
					price,
					total: type !== 'delivery' ? qty * price : 0
				};

				this.tempItems[type].push(newItem);
				this.renderTempItemsTable(type);
				form.querySelector(`#item-selector-${type}`).value = '';
				form.querySelector(`#itemCode-${type}`).value = '';
				form.querySelector(`#itemQty-${type}`).value = '';
				if (type !== 'delivery') form.querySelector(`#itemPrice-${type}`).value = '';
				form.querySelector(`#itemUnit-${type}`).value = '';
			}

        		loadData() {
				const defaultData = {
					penjualan: [],
					pembelian: [],
					suratJalan: [],
					masterItems: [],
					config: {
						noPenjualan: 1,
						noPembelian: 1,
						noSuratJalan: 1,
						namaPerusahaan: "PT. SUMBER GANDA MEKAR",
						alamatPerusahaan: "Jl. Raya Gedebage No. 95 Bandung",
						kontak: "CP. Irwan : 082117800626, CP. Uwem : 082318188863",
						rekening: "BANK BCA No. Rek. 2801011286 a.n Maman Suherman",
						tagline: "JUAL BELI BESI TUA/BARU - RANGKA BETON/LOGAM - TIANG LISTRIK/TELP DAN KONSTRUKSI BAJA",
						logoUrl: "logo.png"
					},
				};

				return new Promise((resolve, reject) => {
					try {
						const dataFromStorage = localStorage.getItem(this.STORAGE_KEY);
						if (dataFromStorage) {
							const parsedData = JSON.parse(dataFromStorage);
							this.data = {
								...defaultData,
								...parsedData,
								config: {...defaultData.config, ...(parsedData.config || {})}
							};
						} else {
							this.data = defaultData;
						}
						resolve();
					} catch(e) {
						this.data = defaultData;
						reject(e);
					}
				});
			}

			filterDropdown(type, showAll = false) {
				const input = document.getElementById(`item-selector-${type}`);
				const filter = input?.value?.toUpperCase() || '';
				const dropdown = document.getElementById(`dropdown-options-${type}`);
				if (!dropdown) return;

				this.closeAllDropdowns();
				dropdown.style.display = 'block';
				this.activeDropdown = dropdown;

				const BATCH_SIZE = 100;
				const sortedItems = [...this.data.masterItems].sort((a, b) => a.name.localeCompare(b.name));
				let optionsHtml = '';
				let count = 0;

				for (const item of sortedItems) {
					if (count >= BATCH_SIZE) break;
					if (showAll || filter === '' || (item.name.toUpperCase().includes(filter) || item.code.toUpperCase().includes(filter))) {
						optionsHtml += `<div class="dropdown-option" data-code="${item.code}">${item.name} <small>(${item.code})</small></div>`;
						count++;
					}
				}

				dropdown.innerHTML = optionsHtml;
				dropdown.style.display = optionsHtml ? 'block' : 'none';
			}

			handleItemInput(type) {
				this.filterDropdown(type);
			}

        		saveData() {
				try {
					localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
				} catch (error) {
					Utils.logError('Failed to save data', error);
					this.showNotification('Gagal menyimpan data ke storage', false);
				}
			}
			
			closeAllDropdowns() {
				document.querySelectorAll('.dropdown-options').forEach(d => d.style.display = 'none');
				this.activeDropdown = null;
			}

			saveDraft(type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				const draftData = {};
				const inputs = form.querySelectorAll('input, select, textarea');
				inputs.forEach(input => {
					if (input.id) {
						draftData[input.id] = input.type === 'checkbox' ? input.checked : input.value;
					}
				});

				const draft = {
					formData: draftData,
					tempItems: this.tempItems[type],
					timestamp: new Date().toISOString()
				};

				this.draftForms[type] = draft;
				localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
			}


			loadDrafts() {
				try {
					const draftData = localStorage.getItem(this.DRAFT_KEY);
					if (draftData) {
						this.draftForms = JSON.parse(draftData);
						['sale', 'purchase', 'delivery'].forEach(type => {
							if (this.draftForms[type] && confirm(`Ditemukan draft ${type} yang belum disimpan. Apakah Anda ingin memulihkannya?`)) {
								this.restoreDraft(type);
							}
						});
					}
				} catch (error) {
					Utils.logError('Failed to load drafts', error);
				}
			}

			restoreDraft(type) {
				const draft = this.draftForms[type];
				if (!draft) return;

				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				Object.entries(draft.formData).forEach(([id, value]) => {
					const input = document.getElementById(id);
					if (input) {
						if (input.type === 'checkbox') {
							input.checked = value;
						} else {
							input.value = value;
						}
					}
				});

				this.tempItems[type] = draft.tempItems || [];
				this.renderTempItemsTable(type);
			}

			async updateAllUI() {
				try {
					this.showLoading(true);
					// The Promise.all was removed to ensure sequential rendering, which can be more stable.
					await this.renderAllTables();
					await this.renderDashboard();
					await this.renderMasterItemsTextarea();
					this.updateMasterItemCountDisplay();
					this.loadConfigToForm();
				} catch (error) {
					Utils.logError('UI update failed', error);
					this.showNotification('Gagal memperbarui UI', false);
				} finally {
					this.showLoading(false);
				}
			}

        		async renderAllTables() {
        			this.renderHistoryTable('penjualan', 'sale-history-table');
        			this.renderHistoryTable('pembelian', 'purchase-history-table');
        			this.renderHistoryTable('suratJalan', 'delivery-history-table');
        		}

        		renderHistoryTable(dataKey, tableId) {
				const tableBody = document.getElementById(tableId);
				if (!tableBody) {
					console.error(`renderHistoryTable: Could not find table body with id "${tableId}"`);
					return;
				}

				const type = dataKey === 'penjualan' ? 'sale' : dataKey === 'pembelian' ? 'purchase' : 'delivery';
				const filters = document.getElementById(`history-filters-${type}`);

				const searchQuery = filters ? (filters.querySelector('.search-query')?.value || '').toUpperCase() : '';
				const startDate = filters ? filters.querySelector('.start-date')?.value : '';
				const endDate = filters ? filters.querySelector('.end-date')?.value : '';

				const dataArray = (this.data[dataKey] || []).filter(item => {
					const party = (item.customer || item.pemasok || item.penerima || '').toUpperCase();
					const idMatch = item.id.toUpperCase().includes(searchQuery);
					const partyMatch = party.includes(searchQuery);
					const dateMatch = (!startDate || item.tanggal >= startDate) && (!endDate || item.tanggal <= endDate);
					return (idMatch || partyMatch) && dateMatch;
				});

				tableBody.innerHTML = '';
				dataArray.slice(0, 100).forEach(item => {
					const row = document.createElement('tr');
					const party = item.customer || item.pemasok || item.penerima || 'N/A';
					const isTransaction = dataKey !== 'suratJalan';
					row.innerHTML = `
        				<td>${item.id}</td>
        				<td>${this.formatDate(item.tanggal)}</td>
        				<td>${party}<br><small>${item.telepon || ''}</small></td>
        				${isTransaction ? `<td class="text-right">${this.formatCurrency(item.grandTotal)}</td>` : `<td>${item.noKendaraan || ''}</td>`}
        				<td class="action-cell">
        					${dataKey === 'penjualan' || dataKey === 'pembelian' ? `
        						<button class="btn btn-sm btn-success" onclick="app.printTransaction('${dataKey}', '${item.id}', 'faktur')">Faktur</button>
        						<button class="btn btn-sm btn-primary" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">SJ</button>
        						<button class="btn btn-sm btn-warning" onclick="app.printTransaction('${dataKey}', '${item.id}', 'kwitansi')">Kwitansi</button>
        					` : `<button class="btn btn-sm btn-success" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">Cetak</button>`}
        					<button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${dataKey}', '${item.id}')">Hapus</button>
        				</td>`;
					tableBody.appendChild(row);
				});
			}

			renderTempItemsTable(type) {
				const tableBody = document.querySelector(`#temp-items-table-${type} tbody`);
				if (!tableBody) return;
				const list = this.tempItems[type];
				tableBody.innerHTML = '';

				list.forEach((item, index) => {
					const row = document.createElement('tr');
					row.innerHTML = `
        				<td>${index + 1}</td>
        				<td>${item.code}</td>
        				<td>${item.name}</td>
        				<td class="text-right">${this.formatNumber(item.qty)}</td>
        				<td>${item.unit}</td>
        				${type !== 'delivery' ? `
        					<td class="text-right">${this.formatCurrency(item.price)}</td>
        					<td class="text-right">${this.formatCurrency(item.total)}</td>
        				` : ''}
        				<td class="action-cell">
        					<button type="button" class="btn btn-sm btn-danger delete-temp-item-btn" data-id="${item.id}">X</button>
        				</td>`;
					tableBody.appendChild(row);
				});

				if(type !== 'delivery') this.calculateTotals(type);
				this.saveDraft(type);
			}

        		showNotification(message, isSuccess = true) {
        			const notifArea = document.getElementById('notification-area');
        			notifArea.textContent = message;
        			notifArea.className = `notification ${isSuccess ? 'success' : 'error'}`;
        			notifArea.style.display = 'block';
        			window.scrollTo(0, 0);
        			setTimeout(() => {
        				notifArea.style.display = 'none';
        			}, 4000);
        		}

			calculateTotals(type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return { subtotal: 0, ppn: 0, discount: 0, shippingCost: 0, grandTotal: 0 };

				const items = this.tempItems[type];
				const subtotal = items.reduce((sum, item) => sum + (item.total || 0), 0);
				
				const discountInput = form.querySelector(`#discount-${type}`);
				const shippingInput = form.querySelector(`#shippingCost-${type}`);
				
				const discount = parseInt((discountInput?.value || '0').replace(/[^0-9]/g, ''), 10) || 0;
				const shippingCost = parseInt((shippingInput?.value || '0').replace(/[^0-9]/g, ''), 10) || 0;
				
				const includePpn = form.querySelector(`#includePpn-${type}`)?.checked;
				const ppn = includePpn ? (subtotal - discount) * 0.11 : 0;
				const grandTotal = subtotal - discount + shippingCost + ppn;

				// Update UI
				form.querySelector(`#subtotal-${type}`).textContent = this.formatCurrency(subtotal);
				form.querySelector(`#ppn-${type}`).textContent = this.formatCurrency(ppn);
				form.querySelector(`#grandTotal-${type}`).textContent = this.formatCurrency(grandTotal);

				return { subtotal, ppn, discount, shippingCost, grandTotal };
			}

        		generateId(type) {
				let num, prefix;
				const date = new Date();
				const year = date.getFullYear().toString().slice(-2);
				const month = (date.getMonth() + 1).toString().padStart(2, '0');

				switch(type) {
					case 'sale':
						num = this.data.config.noPenjualan;
						prefix = 'PJ';
						break;
					case 'purchase':
						num = this.data.config.noPembelian;
						prefix = 'PB';
						break;
					case 'delivery':
						num = this.data.config.noSuratJalan;
						prefix = 'SJ';
						break;
				}
				return `${prefix}${year}${month}-${String(num).padStart(4, '0')}`;
			}

			async saveTransaction(type) {
				try {
					this.showLoading(true);
					const form = document.getElementById(`${type}Form`);
					const dataKey = type === 'sale' ? 'penjualan' : type === 'purchase' ? 'pembelian' : 'suratJalan';
					const tempItems = this.tempItems[type];

					if (tempItems.length === 0) {
						throw new Error('Tambahkan minimal satu barang.');
					}

					const requiredFields = form.querySelectorAll('[required]');
					for (const field of requiredFields) {
						if (!Utils.validateInput(field.value, 'required')) {
							field.focus();
							throw new Error(`Field '${field.labels[0]?.textContent || field.name}' harus diisi.`);
						}
					}

					// Validate phone number if provided
					const phoneInput = form.querySelector(`#${type === 'sale' ? 'customer' : type === 'purchase' ? 'pemasok' : 'recipient'}Phone-${type}`);
					if (phoneInput && phoneInput.value && !Utils.validateInput(phoneInput.value, 'phone')) {
						phoneInput.focus();
						throw new Error('Nomor telepon tidak valid. Gunakan minimal 8 angka, boleh termasuk +, spasi, atau -.');
					}

					const newId = this.generateId(type);
					const isTransaction = type === 'sale' || type === 'purchase';

					const newTrans = {
						id: newId,
						tanggal: form.querySelector(`#${isTransaction ? 'invoiceDate' : 'deliveryDate'}-${type}`).value,
						notes: form.querySelector(`#notes-${type}`).value,
						items: [...tempItems]
					};

					if (isTransaction) {
						const totals = this.calculateTotals(type);
						const partyType = type === 'sale' ? 'customer' : 'pemasok';
						Object.assign(newTrans, {
							[partyType]: form.querySelector(`#${partyType}Name-${type}`).value,
							alamat: form.querySelector(`#${partyType}Address-${type}`).value,
							telepon: form.querySelector(`#${partyType}Phone-${type}`).value,
							noKendaraan: form.querySelector(`#vehicleNo-${type}`)?.value,
							subtotal: totals.subtotal,
							discount: totals.discount,
							shippingCost: totals.shippingCost,
							ppn: totals.ppn,
							grandTotal: totals.grandTotal,
							metodePembayaran: form.querySelector(`#paymentMethod-${type}`).value,
						});
						if (type === 'sale') {
							newTrans.ref = form.querySelector(`#ref-${type}`).value;
							this.data.config.noPenjualan++;
						} else {
							this.data.config.noPembelian++;
						}
					} else { // delivery
						const partyType = 'recipient';
						Object.assign(newTrans, {
							penerima: form.querySelector(`#${partyType}Name-${type}`).value,
							alamat: form.querySelector(`#${partyType}Address-${type}`).value,
							telepon: form.querySelector(`#${partyType}Phone-${type}`).value,
							noKendaraan: form.querySelector(`#vehicleNo-${type}`).value,
						});
						this.data.config.noSuratJalan++;
					}

					this.data[dataKey].unshift(newTrans);
					this.saveData();
					this.resetForm(type);
					await this.updateAllUI();
					this.draftForms[type] = null; // Clear draft after successful save
					localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
					this.showNotification(`Transaksi ${newTrans.id} berhasil disimpan.`);

				} catch (error) {
					Utils.logError('Transaction save failed', error);
					this.showNotification(`Gagal: ${error.message}`, false);
				} finally {
					this.showLoading(false);
				}
			}

        		async deleteTransaction(dataKey, id) {
				if (confirm(`Apakah Anda yakin ingin menghapus transaksi dengan ID: ${id}? Tindakan ini tidak dapat dibatalkan.`)) {
					try {
						this.showLoading(true);
						this.data[dataKey] = this.data[dataKey].filter(item => item.id !== id);
						this.saveData();
						await this.updateAllUI();
						this.showNotification(`Transaksi ${id} telah dihapus.`);
					} catch (error) {
						Utils.logError('Transaction delete failed', error);
						this.showNotification('Gagal menghapus transaksi', false);
					} finally {
						this.showLoading(false);
					}
				}
			}

        		resetForm(type) {
				const form = document.getElementById(`${type}Form`);
				if (!form) return;

				form.reset();
				this.tempItems[type] = [];
				this.renderTempItemsTable(type);

				const isTransaction = type === 'sale' || type === 'purchase';
				const dateInputId = `${isTransaction ? 'invoiceDate' : 'deliveryDate'}-${type}`;
				const dateInput = form.querySelector(`#${dateInputId}`);
				if(dateInput) dateInput.value = new Date().toISOString().slice(0, 10);

				const transNoInput = form.querySelector(`#transNo-${type}`);
				if(transNoInput) transNoInput.value = this.generateId(type);

				// Clear draft from storage
				this.draftForms[type] = null;
				localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));

				this.showNotification(`Form ${type} telah direset.`);
			}

        		generateHistoryHTML(type) {
				const title = type === 'sale' ? 'Penjualan' : type === 'pembelian' ? 'Pembelian' : 'Surat Jalan';
				const tableId = `${type}-history-table`;
				const partyHeader = type === 'sale' ? 'Customer' : type === 'pembelian' ? 'Pemasok' : 'Penerima';

				let headers = `
        				<th>No. Transaksi</th>
        				<th>Tanggal</th>
        				<th>${partyHeader} & Kontak</th>
        			`;
				if (type !== 'delivery') {
					headers += `<th class="text-right">Total</th>`;
				} else {
					headers += `<th>No. Kendaraan</th>`;
				}
				headers += `<th class="action-cell">Aksi</th>`;

				return `
        			<div class="form-section" style="margin-top: 40px;">
        				<h3 class="form-section-title">Riwayat Transaksi ${title}</h3>
        				<div class="history-filters" id="history-filters-${type}">
        					<div class="form-group">
        						<label for="search-${type}">Cari (ID, Nama)</label>
        						<input type="text" class="search-query" id="search-${type}">
        					</div>
        					<div class="form-group">
        						<label for="start-date-${type}">Dari Tanggal</label>
        						<input type="date" class="start-date" id="start-date-${type}">
        					</div>
        					<div class="form-group">
        						<label for="end-date-${type}">Sampai Tanggal</label>
        						<input type="date" class="end-date" id="end-date-${type}">
        					</div>
        				</div>
        				<div class="table-container">
        					<table class="data-table">
        						<thead><tr>${headers}</tr></thead>
        						<tbody id="${tableId}"></tbody>
        					</table>
        				</div>
        			</div>`;
			}

        		generateDashboardHTML() {
				return `
        				<div class="form-section">
        					<h3 class="form-section-title">Statistik Keseluruhan</h3>
        					<div class="stat-cards" id="dashboard-stats">
        					</div>
        				</div>
        				<div class="form-section">
        					<h3 class="form-section-title">Ringkasan Transaksi Terbaru</h3>
        					<div class="history-filters" id="dashboard-filters">
        						<div class="form-group">
        							<label for="dashboard-search">Cari (ID, Nama)</label>
        							<input type="text" class="search-query" id="dashboard-search">
        						</div>
        						<div class="form-group">
        							<label for="dashboard-start-date">Dari Tanggal</label>
        							<input type="date" class="start-date" id="dashboard-start-date">
        						</div>
        						<div class="form-group">
        							<label for="dashboard-end-date">Sampai Tanggal</label>
        							<input type="date" class="end-date" id="dashboard-end-date">
        						</div>
        					</div>
        					<div class="table-container">
        						<table class="data-table" id="dashboard-transactions-table">
        							<thead>
        								<tr>
        									<th>Jenis</th>
        									<th>No. Transaksi</th>
        									<th>Tanggal</th>
        									<th>Nama</th>
        									<th class="text-right">Total</th>
        									<th class="action-cell">Aksi</th>
        								</tr>
        							</thead>
        							<tbody></tbody>
        						</table>
        					</div>
        				</div>`;
			}

        		generateAddItemFormHTML() {
				return `
        			<form id="add-master-item-form-element">
        				<div class="form-grid" style="align-items: flex-end;">
        					<div class="form-group">
        						<label for="newItemCode">Kode Barang</label>
        						<input type="text" id="newItemCode" required>
        					</div>
        					<div class="form-group">
        						<label for="newItemName">Nama Barang</label>
        						<input type="text" id="newItemName" required>
        					</div>
        					<div class="form-group">
        						<label for="newItemUnit">Satuan</label>
        						<input type="text" id="newItemUnit" placeholder="e.g., kg, unit, m">
        					</div>
        					<div class="form-group">
        						<label for="newItemPrice">Harga Default</label>
        						<input type="text" id="newItemPrice" class="rupiah-input" value="0">
        					</div>
        					<div class="form-group">
        						<button type="submit" class="btn btn-primary">Tambah ke Master</button>
        					</div>
        				</div>
        			</form>`;
			}

        		generatePrintHTML(transaction, template, extraData = {}) {
				const config = this.data.config;
				const isTransaction = transaction.grandTotal !== undefined;
				let partyType, partyName;
				if(transaction.customer) { partyType = 'Customer'; partyName = transaction.customer; }
				else if(transaction.pemasok) { partyType = 'Pemasok'; partyName = transaction.pemasok; }
				else { partyType = 'Penerima'; partyName = transaction.penerima; }

				const title = template === 'faktur' ? `FAKTUR ${transaction.customer ? 'PENJUALAN' : 'PEMBELIAN'}` :
							  template === 'kwitansi' ? 'KWITANSI PEMBAYARAN' : 'SURAT JALAN';

				let metaContent = `
        			<table class="meta-table">
        				<tr><td style="width:120px;">Kepada Yth.</td><td>: ${partyName}</td></tr>
        				<tr><td>Alamat</td><td>: ${transaction.alamat || '-'}</td></tr>
        				${transaction.telepon ? `<tr><td>Telepon</td><td>: ${transaction.telepon}</td></tr>` : ''}
        			</table>
        			<table class="meta-table" style="float:right; width: 40%; margin-top:-60px;">
        				<tr><td width="100">No. ${template === 'faktur' ? 'Faktur' : 'Surat Jalan'}</td><td>: ${transaction.id}</td></tr>
        				<tr><td>Tanggal</td><td>: ${this.formatDate(transaction.tanggal)}</td></tr>
        				${isTransaction && transaction.ref ? `<tr><td>Ref</td><td>: ${transaction.ref}</td></tr>` : ''}
        				${(transaction.noKendaraan || extraData.noPol) ? `<tr><td>No. Kendaraan</td><td>: ${extraData.noPol || transaction.noKendaraan || '-'}</td></tr>` : ''}
        			</table>
        			<div style="clear:both;"></div>
        		`;

				if (template === 'kwitansi') {
					metaContent = `
					<table class="meta-table">
						<tr><td width="150">Sudah terima dari</td><td>: ${partyName}</td></tr>
						<tr><td>Uang Sejumlah</td><td>: <b>${this.formatCurrency(transaction.grandTotal)}</b></td></tr>
						<tr><td style="vertical-align:baseline;">Terbilang</td><td style="vertical-align:baseline; font-style:italic; text-transform: capitalize;">: ${this.terbilang(transaction.grandTotal)} rupiah</td></tr>
						<tr><td style="vertical-align:baseline;">Untuk Pembayaran</td><td style="vertical-align:baseline;">: Pelunasan Faktur No. ${transaction.id}</td></tr>
						${transaction.metodePembayaran ? `<tr><td>Metode Pembayaran</td><td>: ${transaction.metodePembayaran}</td></tr>` : ''}
					</table>
					`;
				}

				let itemsContent = ``;
				if (template !== 'kwitansi') {
					itemsContent = `
        				<table class="items-table">
        					<thead>
        						<tr>
        							<th style="width:5%;">No</th>
        							<th style="width:40%;">Nama Barang</th>
        							<th style="width:10%; text-align:right;">Qty</th>
        							<th style="width:10%; text-align:center;">Satuan</th>
        							${isTransaction ? `
        								<th style="width:15%; text-align:right;">Harga Satuan</th>
        								<th style="width:20%; text-align:right;">Jumlah</th>
        							` : ''}
        						</tr>
        					</thead>
        					<tbody>
        						${transaction.items.map((item, i) => `
        							<tr>
        								<td style="text-align:center;">${i + 1}</td>
        								<td>${item.name} ${item.code ? `<small>(${item.code})</small>` : ''}</td>
        								<td style="text-align:right;">${this.formatNumber(item.qty)}</td>
        								<td style="text-align:center;">${item.unit || '-'}</td>
        								${isTransaction ? `
        									<td style="text-align:right;">${this.formatCurrency(item.price, false)}</td>
        									<td style="text-align:right;">${this.formatCurrency(item.total, false)}</td>
        								` : ''}
        							</tr>
        						`).join('')}
        					</tbody>
        				</table>`;
				}

				let summaryContent = '';
				if (isTransaction && template === 'faktur') {
					summaryContent = `
        				<table class="summary-table">
        					<tr><td>Subtotal</td><td style="text-align:right;">${this.formatCurrency(transaction.subtotal, false)}</td></tr>
        					${transaction.discount > 0 ? `<tr><td>Diskon</td><td style="text-align:right;">-${this.formatCurrency(transaction.discount, false)}</td></tr>` : ''}
        					${transaction.ppn > 0 ? `<tr><td>PPN 11%</td><td style="text-align:right;">${this.formatCurrency(transaction.ppn, false)}</td></tr>` : ''}
        					${transaction.shippingCost > 0 ? `<tr><td>Ongkos Kirim</td><td style="text-align:right;">${this.formatCurrency(transaction.shippingCost, false)}</td></tr>` : ''}
        					<tr style="border-top: 1px solid black; font-weight:bold;"><td>Total</td><td style="text-align:right;">${this.formatCurrency(transaction.grandTotal, false)}</td></tr>
        				</table>
        				<div style="clear:both;"></div>
        				<div style="margin-top: 10px; font-style:italic; text-transform: capitalize;">
        					Terbilang: ${this.terbilang(transaction.grandTotal)} rupiah
        				</div>`;
				}

				let signatures = `
        				<div class="print-signatures">
        					<div><p>Penerima,</p><div class="signature-space"></div><p>(${' '.repeat(20)})</p></div>
        					<div><p>Hormat Kami,</p><div class="signature-space"></div><p>(${config.namaPerusahaan})</p></div>
        				</div>
        			`;

				if (template === 'surat_jalan') {
					signatures = `
        				<div class="print-signatures">
        					<div><p>Pengirim,</p><div class="signature-space"></div><p>(${' '.repeat(20)})</p></div>
        					<div><p>Gudang,</p><div class="signature-space"></div><p>(${' '.repeat(20)})</p></div>
        					<div><p>Penerima,</p><div class="signature-space"></div><p>(${' '.repeat(20)})</p></div>
        				</div>`;
				}

				if (template === 'kwitansi') {
					signatures = `
        				<div class="print-signatures" style="justify-content:flex-end;">
        					<div><p>Bandung, ${this.formatDate(transaction.tanggal)}</p><div class="signature-space"></div><p>(${config.namaPerusahaan})</p></div>
        				</div>`;
				}

				return `
        			<div class="page printable-content">
        				<div class="print-header">
        					<div class="company-info">
        						<h3>${config.namaPerusahaan}</h3>
        						<p>${config.tagline}</p>
        						<p>${config.alamatPerusahaan}</p>
        						<p>${config.kontak}</p>
        					</div>
        					<img src="${config.logoUrl || 'https://via.placeholder.com/150x50.png?text=Logo'}" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/150x50.png?text=Logo';">
        				</div>
        				<div class="print-section ${template === 'kwitansi' ? 'kwitansi' : ''}">
        					<h4 style="text-decoration: underline; text-align:center; margin-bottom: 5mm;">${title}</h4>
        					${metaContent}
        					${itemsContent}
        					${summaryContent}
        					${transaction.notes ? `<div style="border-top: 1px solid #ccc; margin-top: 5mm; padding-top: 5mm;"><p><b>Keterangan:</b> ${transaction.notes}</p></div>` : ''}
        				</div>
        				<div class="print-footer">
        					${isTransaction && template === 'faktur' ? `<p style="font-size:8pt; text-align:center;">Pembayaran mohon di transfer ke rekening ${config.rekening}</p>` : ''}
        					${signatures}
        				</div>
        			</div>`;
			}

			async renderDashboard() {
				const statsContainer = document.getElementById('dashboard-stats');
				const tableBody = document.querySelector('#dashboard-transactions-table tbody');

				if (!statsContainer || !tableBody) return;

				const filters = document.getElementById('dashboard-filters');
				const searchQuery = (filters.querySelector('.search-query')?.value || '').toUpperCase();
				const startDate = filters.querySelector('.start-date')?.value;
				const endDate = filters.querySelector('.end-date')?.value;
				
				const filterPredicate = (t) => {
					const party = (t.customer || t.pemasok || t.penerima || '').toUpperCase();
					const idMatch = t.id.toUpperCase().includes(searchQuery);
					const partyMatch = party.includes(searchQuery);
					const dateMatch = (!startDate || t.tanggal >= startDate) && (!endDate || t.tanggal <= endDate);
					return (idMatch || partyMatch) && dateMatch;
				};

				const filteredSales = this.data.penjualan.filter(filterPredicate);
				const filteredPurchases = this.data.pembelian.filter(filterPredicate);

				const totalSales = filteredSales.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
				const totalPurchases = filteredPurchases.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
				const profit = totalSales - totalPurchases;

				const allTransactions = [
					...this.data.penjualan.map(t => ({ ...t, type: 'Penjualan', dataKey: 'penjualan' })),
					...this.data.pembelian.map(t => ({ ...t, type: 'Pembelian', dataKey: 'pembelian' })),
					...this.data.suratJalan.map(t => ({ ...t, type: 'Surat Jalan', dataKey: 'suratJalan' }))
				]
				.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

				const totalTransactions = allTransactions.length;

				statsContainer.innerHTML = `
        			<div class="stat-card">
        				<div class="stat-card-title">Total Penjualan (Filtered)</div>
        				<div class="stat-card-value profit">${this.formatCurrency(totalSales)}</div>
        			</div>
        			<div class="stat-card">
        				<div class="stat-card-title">Total Pembelian (Filtered)</div>
        				<div class="stat-card-value loss">${this.formatCurrency(totalPurchases)}</div>
        			</div>
        			<div class="stat-card">
        				<div class="stat-card-title">Laba Kotor (Filtered)</div>
        				<div class="stat-card-value ${profit >= 0 ? 'profit' : 'loss'}">${this.formatCurrency(profit)}</div>
        			</div>
        			<div class="stat-card">
        				<div class="stat-card-title">Jumlah Transaksi (Total)</div>
        				<div class="stat-card-value">${this.formatNumber(totalTransactions)}</div>
        			</div>`;

				tableBody.innerHTML = '';
				allTransactions.filter(filterPredicate).slice(0, 50).forEach(t => {
					const row = document.createElement('tr');
					const party = t.customer || t.pemasok || t.penerima || 'N/A';
					row.innerHTML = `
        				<td><span class="btn btn-sm ${t.dataKey === 'penjualan' ? 'btn-success' : t.dataKey === 'pembelian' ? 'btn-danger' : 'btn-info'}">${t.type}</span></td>
        				<td>${t.id}</td>
        				<td>${this.formatDate(t.tanggal)}</td>
        				<td>${party}</td>
        				<td class="text-right">${t.grandTotal !== undefined ? this.formatCurrency(t.grandTotal) : '-'}</td>
        				<td class="action-cell">
        					${t.type !== 'Surat Jalan' ? `
        						<button class="btn btn-sm btn-info" onclick="app.printTransaction('${t.dataKey}', '${t.id}', 'faktur')">Faktur</button>
        					` : `
        						<button class="btn btn-sm btn-info" onclick="app.printTransaction('${t.dataKey}', '${t.id}', 'surat_jalan')">Cetak</button>
        					`}
        					<button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${t.dataKey}', '${t.id}')">Hapus</button>
        				</td>`;
					tableBody.appendChild(row);
				});
			}
			
			// ***FIXED***: Added the missing terbilang function
			terbilang(nilai) {
				const bilangan = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
				
				if (nilai < 12) {
					return bilangan[nilai];
				} else if (nilai < 20) {
					return this.terbilang(nilai - 10) + " belas";
				} else if (nilai < 100) {
					return this.terbilang(Math.floor(nilai / 10)) + " puluh " + this.terbilang(nilai % 10);
				} else if (nilai < 200) {
					return "seratus " + this.terbilang(nilai - 100);
				} else if (nilai < 1000) {
					return this.terbilang(Math.floor(nilai / 100)) + " ratus " + this.terbilang(nilai % 100);
				} else if (nilai < 2000) {
					return "seribu " + this.terbilang(nilai - 1000);
				} else if (nilai < 1000000) {
					return this.terbilang(Math.floor(nilai / 1000)) + " ribu " + this.terbilang(nilai % 1000);
				} else if (nilai < 1000000000) {
					return this.terbilang(Math.floor(nilai / 1000000)) + " juta " + this.terbilang(nilai % 1000000);
				} else if (nilai < 1000000000000) {
					return this.terbilang(Math.floor(nilai / 1000000000)) + " milyar " + this.terbilang(nilai % 1000000000);
				} else if (nilai < 1000000000000000) {
					return this.terbilang(Math.floor(nilai / 1000000000000)) + " trilyun " + this.terbilang(nilai % 1000000000000);
				}
				return "";
			}

			// Other methods for settings, backup, csv etc.
			// ...
			formatDate(dateString) {
				if (!dateString) return '';
				const [year, month, day] = dateString.split('-');
				return `${day}/${month}/${year}`;
			}
			
			deleteItemFromTempList(id, type) {
				this.tempItems[type] = this.tempItems[type].filter(item => item.id !== id);
				this.renderTempItemsTable(type);
			}

			async renderMasterItemsTextarea() {
				const textarea = document.getElementById('masterItemJson');
				if (textarea) {
					textarea.value = JSON.stringify(this.data.masterItems, null, 2);
				}
			}

			updateMasterItemCountDisplay() {
				const countSpan = document.getElementById('master-item-count');
				if (countSpan) {
					countSpan.textContent = this.data.masterItems.length;
				}
			}
			
			loadConfigToForm() {
				const config = this.data.config;
				for (const key in config) {
					const input = document.getElementById(`config-${key}`);
					if(input) input.value = config[key];
				}
				// Update header
				document.getElementById('header-title').textContent = config.namaPerusahaan || 'Sistem Akuntansi';
				document.getElementById('header-tagline').textContent = config.tagline || 'Pencatatan Penjualan dan Pembelian';
				document.getElementById('header-logo').src = config.logoUrl || 'https://via.placeholder.com/150x50.png?text=Logo';
			}

			saveConfig() {
				const config = this.data.config;
				for (const key in config) {
					const input = document.getElementById(`config-${key}`);
					if (input) {
						this.data.config[key] = input.value;
					}
				}
				this.saveData();
				this.loadConfigToForm(); // Refresh UI
				this.showNotification('Informasi perusahaan berhasil disimpan.');
			}

			saveMasterItemsFromTextarea() {
				const textarea = document.getElementById('masterItemJson');
				try {
					const items = JSON.parse(textarea.value);
					if (!Array.isArray(items)) {
						throw new Error('Format JSON harus berupa array.');
					}
					// Basic validation
					const isValid = items.every(item => item.hasOwnProperty('code') && item.hasOwnProperty('name'));
					if (!isValid) {
						throw new Error('Setiap item dalam JSON harus memiliki properti "code" dan "name".');
					}
					this.data.masterItems = items;
					this.saveData();
					this.updateMasterItemCountDisplay();
					this.showNotification('Data master barang berhasil disimpan dari JSON.');
				} catch (error) {
					Utils.logError('Failed to save master items from JSON', error);
					this.showNotification(`Gagal menyimpan: ${error.message}`, false);
				}
			}
			
			clearMasterItems() {
				if(confirm('Apakah Anda yakin ingin menghapus semua data master barang?')) {
					this.data.masterItems = [];
					this.saveData();
					this.updateAllUI();
					this.showNotification('Semua data master barang telah dihapus.');
				}
			}

			backupData() {
				const dataStr = JSON.stringify(this.data, null, 2);
				const blob = new Blob([dataStr], {type: "application/json"});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `backup_akuntansi_${new Date().toISOString().slice(0,10)}.json`;
				a.click();
				URL.revokeObjectURL(url);
				this.showNotification('Backup data berhasil diunduh.');
			}
			
			restoreData(event) {
				const file = event.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = async (e) => {
					try {
						const restoredData = JSON.parse(e.target.result);
						// Simple validation
						if (restoredData.config && restoredData.penjualan && restoredData.pembelian) {
							if (confirm('Yakin ingin memulihkan data? Semua data saat ini akan ditimpa.')) {
								this.data = restoredData;
								this.saveData();
								await this.updateAllUI();
								this.loadDrafts();
								this.showNotification('Data berhasil dipulihkan.');
							}
						} else {
							throw new Error('File backup tidak valid.');
						}
					} catch(err) {
						Utils.logError('Restore failed', err);
						this.showNotification(`Gagal memulihkan: ${err.message}`, false);
					} finally {
						// Reset file input
						event.target.value = '';
					}
				};
				reader.readAsText(file);
			}

			exportMasterItemsToCsv() {
				if (this.data.masterItems.length === 0) {
					this.showNotification('Tidak ada data barang untuk diekspor.', false);
					return;
				}
				const headers = ['code', 'name', 'unit', 'price'];
				const csvRows = [
					headers.join(','),
					...this.data.masterItems.map(item => headers.map(header => `"${item[header] || ''}"`).join(','))
				];
				const csvString = csvRows.join('\n');
				const blob = new Blob([csvString], { type: 'text/csv' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'master_barang.csv';
				a.click();
				URL.revokeObjectURL(url);
			}

			importMasterItemsFromCsv(event) {
				const file = event.target.files[0];
				if (!file) return;
				
				const reader = new FileReader();
				reader.onload = (e) => {
					try {
						const csv = e.target.result;
						const lines = csv.split(/\r\n|\n/);
						const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
						const requiredHeaders = ['code', 'name'];
						if (!requiredHeaders.every(h => headers.includes(h))) {
							throw new Error('CSV harus memiliki kolom "code" dan "name".');
						}

						const newItems = [];
						for (let i = 1; i < lines.length; i++) {
							if (!lines[i]) continue;
							const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
							const item = {};
							headers.forEach((header, index) => {
								item[header] = values[index];
							});
							newItems.push(item);
						}
						
						if(confirm(`Ditemukan ${newItems.length} barang dari CSV. Apakah Anda ingin menimpa data barang yang ada?`)) {
							this.data.masterItems = newItems;
							this.saveData();
							this.updateAllUI();
							this.showNotification('Data barang berhasil diimpor dari CSV.');
						}

					} catch(err) {
						Utils.logError('CSV Import failed', err);
						this.showNotification(`Gagal mengimpor: ${err.message}`, false);
					} finally {
						event.target.value = '';
					}
				};
				reader.readAsText(file);
			}
			
			addNewMasterItem() {
				const code = document.getElementById('newItemCode').value.trim();
				const name = document.getElementById('newItemName').value.trim();
				const unit = document.getElementById('newItemUnit').value.trim();
				const price = parseInt(document.getElementById('newItemPrice').value.replace(/[^0-9]/g, ''), 10) || 0;
				
				if (!code || !name) {
					this.showNotification('Kode dan Nama Barang harus diisi.', false);
					return;
				}
				if (this.data.masterItems.some(item => item.code === code)) {
					this.showNotification(`Kode barang '${code}' sudah ada.`, false);
					return;
				}
				
				this.data.masterItems.unshift({ code, name, unit, price });
				this.saveData();
				this.renderMasterItemsTextarea();
				this.updateMasterItemCountDisplay();
				this.showNotification(`Barang '${name}' berhasil ditambahkan.`);
				document.getElementById('add-master-item-form-element').reset();
			}

			printTransaction(dataKey, id, template) {
				const transaction = this.data[dataKey].find(t => t.id === id);
				if (!transaction) {
					this.showNotification('Transaksi tidak ditemukan.', false);
					return;
				}

				const printArea = document.getElementById('print-area');
				printArea.innerHTML = this.generatePrintHTML(transaction, template);
				window.print();
			}

        	} // End of SistemAkuntansi class

        	// Initialize the app
        	const app = new SistemAkuntansi();
		
		// Tab switching logic
		document.addEventListener('DOMContentLoaded', () => {
			const tabs = document.querySelectorAll('.nav-tab');
			const tabContents = document.querySelectorAll('.tab-content');

			tabs.forEach(tab => {
				tab.addEventListener('click', () => {
					// Deactivate all tabs and contents
					tabs.forEach(t => t.classList.remove('active'));
					tabContents.forEach(c => c.classList.remove('active'));

					// Activate clicked tab and its content
					tab.classList.add('active');
					const activeContent = document.getElementById(tab.dataset.tab);
					if (activeContent) {
						activeContent.classList.add('active');
					}
					if(tab.dataset.tab === 'dashboard'){
						app.renderDashboard();
					}
				});
			});
		});

    </script>
  </body>
</html>