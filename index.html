<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Sistem Penjualan dan Pembelian dengan Ekspor PDF & Excel" />
    <meta name="author" content="Sistem Akuntansi v4.8 - Export Ready" />
    <title>Sistem Akuntansi v4.8 (Export Ready)</title>
    <style>
      :root {
        --primary: #003087;
        --primary-dark: #002060;
        --secondary: #d32f2f;
        --success: #2e7d32;
        --warning: #f57c00;
        --danger: #c62828;
        --info: #0277bd;
        --dark: #212121;
        --light: #fafafa;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --border: #e0e0e0;
        --text: var(--dark);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: #f4f6f8; 
        color: var(--text); 
        min-height: 100vh;
        padding: 15px;
        font-size: 15px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--light);
        border-radius: 8px;
        padding: 25px;
        box-shadow: var(--shadow);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        text-align: left;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
      }
      .header img {
        max-height: 60px;
      }
      .header h1 {
        color: var(--primary);
        font-size: 1.9rem;
        font-weight: 600;
        margin: 0;
      }
      .header .subtitle {
        color: #616161;
        font-size: 1rem;
        margin: 0;
      }
      .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--border);
      }
      .nav-tab {
        padding: 12px 25px;
        background: var(--light);
        border: 1px solid var(--border);
        border-bottom: none;
        cursor: pointer;
        font-weight: 500;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        margin-right: 5px;
        transition: all 0.2s;
        color: var(--text);
        margin-bottom: -1px;
      }
      .nav-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .nav-tab:hover:not(.active) {
        background: #e9ecef;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .form-section {
        background: #fdfdfd;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }
      .form-section-title {
        color: var(--primary);
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .form-group label {
        color: var(--dark);
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.95rem;
        background: #ffffff;
        color: var(--dark);
        transition: border-color 0.2s;
        font-family: inherit;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.15);
      }
      .form-group input[readonly] {
        background: #e9ecef;
        cursor: not-allowed;
        font-weight: 500;
      }
      .form-group input:invalid {
        border-color: var(--danger);
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-warning {
        background: var(--warning);
        color: white;
      }
      .btn-info {
        background: var(--info);
        color: white;
      }
      .btn-sm {
        padding: 5px 10px;
        font-size: 0.8rem;
      }
      .actions-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }
      .table-container {
        margin-top: 20px;
        overflow-x: auto;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      .data-table th,
      .data-table td {
        padding: 10px 12px;
        border: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }
      .data-table thead th {
        background: #f4f6f8;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .data-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .data-table td.text-right,
      .data-table th.text-right {
        text-align: right;
      }
      .data-table .action-cell {
        text-align: center;
        white-space: nowrap;
      }
      .data-table .action-cell .btn {
        margin: 2px;
      }
      .summary-section {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
      }
      .summary-grid {
        width: 100%;
        max-width: 450px;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
      }
      .summary-grid label {
        font-weight: 600;
        text-align: right;
        padding-right: 10px;
        align-self: center;
      }
      .summary-grid .total-amount-display {
        grid-column: 2 / 3;
      }
      .total-amount-display {
        font-size: 1.1rem;
        font-weight: bold;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
        text-align: right;
      }
      .notification {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        border: 1px solid transparent;
        display: none;
        animation: fadeIn 0.5s;
      }
      .notification.success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .notification.error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .notification button {
          float: right;
          background: none;
          border: none;
          font-size: 1.2rem;
          cursor: pointer;
          line-height: 1;
          color: inherit;
      }
      .filterable-dropdown {
        position: relative;
      }
      .dropdown-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid var(--border);
        border-top: none;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .dropdown-option {
        padding: 10px;
        cursor: pointer;
      }
      .dropdown-option:hover, .dropdown-option.focused {
        background-color: #f0f0f0;
      }
      .dropdown-option small {
        color: #888;
        display: block;
      }
      .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .stat-card-title {
        font-size: 1rem;
        color: #616161;
        margin-bottom: 10px;
      }
      .stat-card-value {
        font-size: 2rem;
        font-weight: 600;
        color: var(--primary);
        word-wrap: break-word;
      }
      .stat-card-value.profit {
        color: var(--success);
      }
      .stat-card-value.loss {
        color: var(--danger);
      }
      .history-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
      }
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #print-area {
        display: none;
      }
      #print-preview-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.6);
          z-index: 3000;
          display: flex;
          justify-content: center;
          align-items: center;
          overflow-y: auto;
          padding: 20px;
      }
      #print-preview-modal .modal-content {
          background: white;
          padding: 25px;
          border-radius: 8px;
          max-width: 840px; /* A4 width-ish */
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
      }
      #print-preview-modal .modal-body {
          border: 1px solid #ccc;
          padding: 10px;
          margin-bottom: 20px;
      }
       #print-preview-modal .modal-actions {
          text-align: right;
          display: flex;
          gap: 10px;
          justify-content: flex-end;
      }

      @media print {
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-size: 10pt !important; /* Pastikan font seragam */
        }
        body,
        html {
          width: 210mm;
          height: 100%;
          margin: 0 !important;
          padding: 0 !important;
        }
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        body,
        .printable-content {
          margin: 0;
          padding: 0;
          font-family: "Courier New", Courier, monospace;
          color: #000;
          font-size: 10pt;
        }
        body > *:not(#print-area) {
          display: none !important;
        }
        #print-area {
          display: block !important;
        }
        .page {
          width: 210mm;
          min-height: 148mm;
          padding: 10mm !important;
          margin: 0 auto;
          page-break-after: always;
        }
        .page:last-child {
          page-break-after: avoid;
        }
        .print-header {
          display: flex;
          align-items: flex-start;
          justify-content: space-between;
          margin-bottom: 5mm;
          border-bottom: 2px solid #000;
          padding-bottom: 5mm;
        }
        .print-header .company-info {
          text-align: left;
        }
        .print-header .logo {
          max-height: 50px;
          max-width: 150px;
        }
        .print-header h3 {
          font-size: 14pt;
          margin: 0;
          color: #000;
        }
        .print-header p {
          font-size: 9pt;
          margin: 2px 0;
          color: #000;
        }
        .print-section {
          border: 1px solid #000;
          padding: 5mm;
          margin-top: 5mm;
        }
        .print-section.kwitansi {
          border-style: dashed;
        }
        .print-section h4 {
          text-align: center;
          margin-bottom: 5mm;
          text-decoration: underline;
          font-size: 12pt;
        }
        .meta-table {
          width: 100%;
          margin-bottom: 5mm;
          font-size: 10pt;
        }
        .meta-table td {
          vertical-align: top;
          padding: 1px 2px;
        }
        .items-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 5mm;
          font-size: 10pt;
        }
        .items-table th,
        .items-table td {
          border: 0.1mm solid #000 !important;
          padding: 2mm !important;
        }
        .items-table th {
          background-color: #eee !important;
        }
        .summary-table {
          width: 50%;
          float: right;
          margin-top: 5mm;
          border-collapse: collapse;
          font-size: 10pt;
        }
        .summary-table td {
          padding: 2px 5px;
        }
        .kwitansi-box {
          border: 1px solid #000;
          padding: 5mm;
          margin: 5mm 0;
        }
        .kwitansi-box .terbilang {
          font-style: italic;
          font-weight: bold;
        }
        .print-footer {
          margin-top: 10mm;
        }
        .print-signatures {
          display: flex;
          justify-content: space-around;
          text-align: center;
          width: 100%;
          margin-top: 15mm;
        }
        .print-signatures > div {
          width: 30%;
        }
        .signature-space {
          height: 60px;
        }
      }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="container">
      <div class="header">
        <img
          src="logo.png"
          id="header-logo"
          alt="Logo Perusahaan"
          onerror="this.onerror=null; this.src='https://via.placeholder.com/150x50.png?text=Logo';"
        />
        <div>
          <h1 id="header-title">Sistem Akuntansi Terpadu</h1>
          <p class="subtitle" id="header-tagline">
            Pencatatan Penjualan, Pembelian, dan Surat Jalan
          </p>
        </div>
      </div>

      <div class="nav-tabs" role="tablist">
        <button class="nav-tab active" data-tab="dashboard" role="tab">
          Dashboard
        </button>
        <button class="nav-tab" data-tab="penjualan" role="tab">
          Penjualan
        </button>
        <button class="nav-tab" data-tab="pembelian" role="tab">
          Pembelian
        </button>
        <button class="nav-tab" data-tab="suratJalan" role="tab">
          Surat Jalan
        </button>
        <button class="nav-tab" data-tab="pengaturan" role="tab">
          Pengaturan
        </button>
      </div>

      <div id="notification-area" class="notification"></div>

      <div id="dashboard" class="tab-content active" role="tabpanel"></div>
      <div id="penjualan" class="tab-content" role="tabpanel"></div>
      <div id="pembelian" class="tab-content" role="tabpanel"></div>
      <div id="suratJalan" class="tab-content" role="tabpanel"></div>

      <div id="pengaturan" class="tab-content" role="tabpanel">
        <div class="form-section">
          <h3 class="form-section-title">Pengaturan Informasi Perusahaan</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="config-namaPerusahaan">Nama Perusahaan</label
              ><input type="text" id="config-namaPerusahaan" required />
            </div>
            <div class="form-group">
              <label for="config-alamatPerusahaan">Alamat Perusahaan</label
              ><input type="text" id="config-alamatPerusahaan" required />
            </div>
            <div class="form-group">
              <label for="config-kontak">Kontak</label
              ><input type="text" id="config-kontak" required />
            </div>
            <div class="form-group">
              <label for="config-rekening">Info Rekening Bank</label
              ><input type="text" id="config-rekening" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1">
              <label for="config-logoUrl"
                >URL Logo (Ganti dengan link logo Anda)</label
              ><input type="url" id="config-logoUrl" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1">
              <label for="config-tagline">Tagline/Deskripsi (untuk SJ)</label
              ><textarea id="config-tagline" rows="2"></textarea>
            </div>
          </div>
          <div class="actions-group">
            <button type="button" id="saveConfigBtn" class="btn btn-primary">
              Simpan Informasi
            </button>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Manajemen Data Barang</h3>
          <div id="add-master-item-form"></div>
          <hr style="margin: 20px 0" />
          <p style="margin-bottom: 15px; font-weight: bold">
            Status: <span id="master-item-count">0</span> barang termuat.
          </p>
          <div class="form-group">
            <label for="masterItemJson"
              >Edit Massal Data Master (Format JSON)</label
            >
            <textarea
              id="masterItemJson"
              rows="10"
              placeholder="Tempel (paste) data JSON dari skrip Python di sini..."
            ></textarea>
          </div>
          <div class="actions-group">
            <button
              type="button"
              id="saveMasterItemsBtn"
              class="btn btn-primary"
            >
              Simpan dari JSON
            </button>
            <button type="button" id="exportCsvBtn" class="btn btn-success">
              Export CSV
            </button>
            <button type="button" id="importCsvBtn" class="btn btn-warning">
              Import CSV
            </button>
            <input
              type="file"
              id="csvFileInput"
              style="display: none"
              accept=".csv"
            />
            <button
              type="button"
              id="clearMasterItemsBtn"
              class="btn btn-danger"
            >
              Hapus Semua Barang
            </button>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">Backup & Restore</h3>
          <p style="margin-bottom: 15px">
            Simpan semua data transaksi dan data barang ke dalam satu file JSON,
            atau pulihkan dari file cadangan.
          </p>
          <div class="actions-group">
            <button type="button" id="backupDataBtn" class="btn btn-success">
              Backup Semua Data
            </button>
            <button type="button" id="restoreDataBtn" class="btn btn-warning">
              Restore Data
            </button>
            <input
              type="file"
              id="restoreFileInput"
              style="display: none"
              accept=".json"
            />
          </div>
        </div>
         <div id="trash-section"></div>
      </div>
    </div>

    <div id="print-area"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script>
      /**
       * Utility functions for common operations
       */
      const Utils = {
        formatRupiahInput(input) {
          let value = input.value.replace(/[^0-9]/g, "");
          if (value === "") {
            input.value = "";
            return;
          }
          const number = parseInt(value, 10);
          if (isNaN(number)) {
            input.value = "";
            return;
          }
          input.value = new Intl.NumberFormat("id-ID").format(number);
        },
        debounce(func, wait) {
          let timeout;
          return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
          };
        },
        validateInput: (value, type) => {
          switch (type) {
            case "required":
              return !!value.trim();
            case "number":
              return !isNaN(value) && value >= 0;
            case "url":
              try {
                new URL(value);
                return true;
              } catch (e) {
                return false;
              }
            case "phone":
              return /^\+?[\d\s-]{8,}$/.test(value);
            default:
              return true;
          }
        },
        logError: (message, error) => {
          console.error(`[SistemAkuntansi] ${message}`, error);
        },
      };

      /**
       * Main accounting system class
       */
      class SistemAkuntansi {
        constructor() {
          this.STORAGE_KEY = "sistemAkuntansiData_v4.8";
          this.DRAFT_KEY = "sistemAkuntansiDraft_v4.8";
          this.TRASH_KEY = "sistemAkuntansiTrash_v4.8";

          this.data = null;
          this.trash = [];
          this.activeDropdown = null;
          this.tempItems = { sale: [], purchase: [], delivery: [] };
          this.draftForms = { sale: null, purchase: null, delivery: null };
          this.partyNames = {
            customer: new Set(),
            pemasok: new Set(),
            recipient: new Set(),
          };
          this.itemIndex = new Map();
          this.isLoading = false;
          this.eventControllers = new Map();
          this.notificationTimeout = null;
        }

        async init() {
          try {
            this.cleanup();
            console.log("Starting init...");
            this.showLoading(true);
            await this.loadData();
            this.buildDOM();
            this.bindGlobalEvents();
            await this.updateAllUI();
            this.loadDrafts();
          } catch (error) {
            Utils.logError("Initialization failed", error);
            this.showNotification(
              "Gagal memuat sistem: " + error.message,
              false
            );
          } finally {
            this.showLoading(false);
          }
        }

        showLoading(show) {
          this.isLoading = show;
          document.getElementById("loadingOverlay").style.display = show
            ? "flex"
            : "none";
        }

        cleanup() {
          this.eventControllers.forEach((controller) => controller.abort());
          this.eventControllers.clear();
        }

        buildDOM() {
          this.cleanup();
          ["sale", "purchase", "delivery"].forEach((type) => {
            const containerId =
              type === "sale"
                ? "penjualan"
                : type === "purchase"
                ? "pembelian"
                : "suratJalan";
            const container = document.getElementById(containerId);
            if (container)
              container.innerHTML =
                this.generateFormHTML(type) + this.generateHistoryHTML(type);
          });

          const dashboardContainer = document.getElementById("dashboard");
          if (dashboardContainer)
            dashboardContainer.innerHTML = this.generateDashboardHTML();

          const addItemContainer = document.getElementById(
            "add-master-item-form"
          );
          if (addItemContainer)
            addItemContainer.innerHTML = this.generateAddItemFormHTML();

          const pengaturanContainer = document.getElementById("pengaturan");
          if (pengaturanContainer) {
            let trashSection = document.getElementById("trash-section");
            if (trashSection) {
                 trashSection.remove();
            }
            trashSection = document.createElement("div");
            trashSection.id = "trash-section";
            pengaturanContainer.appendChild(trashSection);
            trashSection.innerHTML = this.generateTrashHTML();
            this.renderTrashTable();
          }
        }

        generateFormHTML(type) {
          const isTransaction = type === "sale" || type === "purchase";
          const title =
            type === "sale"
              ? "Penjualan"
              : type === "purchase"
              ? "Pembelian"
              : "Surat Jalan";
          const partyLabel =
            type === "sale"
              ? "Customer"
              : type === "purchase"
              ? "Pemasok"
              : "Penerima";
          const partyType =
            type === "sale"
              ? "customer"
              : type === "purchase"
              ? "pemasok"
              : "recipient";

          let formFields = `
            <div class="form-group">
                <label for="transNo-${type}">No. Transaksi</label>
                <input type="text" id="transNo-${type}" readonly value="${this.generateId(type)}">
            </div>
            <div class="form-group">
                <label for="${isTransaction ? "invoiceDate" : "deliveryDate"}-${type}">Tanggal</label>
                <input type="date" id="${isTransaction ? "invoiceDate" : "deliveryDate"}-${type}" required value="${new Date().toISOString().slice(0, 10)}">
            </div>
            <div class="form-group filterable-dropdown">
                <label for="${partyType}Name-${type}">Nama ${partyLabel}</label>
                <input type="text" id="${partyType}Name-${type}" required autocomplete="off">
                <div class="dropdown-options" id="party-dropdown-${type}"></div>
            </div>
            <div class="form-group">
                <label for="${partyType}Address-${type}">Alamat ${partyLabel}</label>
                <input type="text" id="${partyType}Address-${type}">
            </div>
            <div class="form-group">
                <label for="${partyType}Phone-${type}">Telepon ${partyLabel}</label>
                <input type="tel" id="${partyType}Phone-${type}" pattern="\\+?[\\d\\s-]{8,}">
            </div>
            <div class="form-group">
                <label for="vehicleNo-${type}">No. Kendaraan</label>
                <input type="text" id="vehicleNo-${type}">
            </div>
      `;

          if (isTransaction) {
            formFields += `
                ${type === "sale" ? `<div class="form-group"><label for="ref-${type}">Ref</label><input type="text" id="ref-${type}"></div>` : ""}
                <div class="form-group">
                    <label for="paymentMethod-${type}">Metode Pembayaran</label>
                    <select id="paymentMethod-${type}">
                        <option value="Transfer">Transfer</option>
                        <option value="Tunai">Tunai</option>
                        <option value="Kredit">Kredit</option>
                    </select>
                </div>`;
          }

          const itemFields = `
            <div class="form-section">
                <h3 class="form-section-title">Tambah Barang</h3>
                <div class="form-grid">
                    <div class="form-group filterable-dropdown" style="grid-column: 1 / -1;">
                        <label for="item-selector-${type}">Cari Barang (Nama/Kode)</label>
                        <input type="text" id="item-selector-${type}" autocomplete="off">
                        <div class="dropdown-options" id="dropdown-options-${type}"></div>
                    </div>
                    <div class="form-group">
                        <label for="itemCode-${type}">Kode Barang</label>
                        <input type="text" id="itemCode-${type}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="itemQty-${type}">Jumlah</label>
                        <input type="number" id="itemQty-${type}" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="itemUnit-${type}">Satuan</label>
                        <input type="text" id="itemUnit-${type}">
                    </div>
                    ${isTransaction ? `<div class="form-group"><label for="itemPrice-${type}">Harga Satuan (Rp)</label><input type="text" id="itemPrice-${type}" class="rupiah-input" required></div>` : ""}
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" id="addItemBtn-${type}" class="btn btn-primary">Tambah Barang</button>
                    </div>
                </div>
            </div>`;

          const tableHeaders = isTransaction
            ? `<th>No</th><th>Kode</th><th>Nama Barang</th><th class="text-right">Jumlah</th><th>Satuan</th><th class="text-right">Harga Satuan</th><th class="text-right">Total</th><th class="action-cell">Aksi</th>`
            : `<th>No</th><th>Kode</th><th>Nama Barang</th><th class="text-right">Jumlah</th><th>Satuan</th><th class="action-cell">Aksi</th>`;

          const summarySection = isTransaction
            ? `<div class="summary-section">
                <div class="summary-grid">
                    <label>Subtotal:</label>
                    <div class="total-amount-display" id="subtotal-${type}">Rp 0</div>
                    <label for="discount-${type}">Diskon (Rp):</label>
                    <input type="text" id="discount-${type}" class="rupiah-input" value="0">
                    <label for="shippingCost-${type}">Ongkos Kirim (Rp):</label>
                    <input type="text" id="shippingCost-${type}" class="rupiah-input" value="0">
                    <label>PPN 11%:</label>
                    <div class="form-group" style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                        <input type="checkbox" id="includePpn-${type}" style="width: auto;">
                        <label for="includePpn-${type}" style="margin-bottom: 0;">Sertakan PPN</label>
                    </div>
                    <div></div>
                    <div class="total-amount-display" id="ppn-${type}">Rp 0</div>
                    <label>Grand Total:</label>
                    <div class="total-amount-display" id="grandTotal-${type}">Rp 0</div>
                </div>
            </div>` : "";

          return `<div class="form-section">
                <h3 class="form-section-title">Form ${title}</h3>
                <form id="${type}Form">
                    <div class="form-grid">${formFields}</div>
                    ${itemFields}
                    <div class="table-container">
                        <table class="data-table" id="temp-items-table-${type}">
                            <thead><tr>${tableHeaders}</tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    ${summarySection}
                    <div class="form-group" style="grid-column: 1 / -1; margin-top: 20px;">
                        <label for="notes-${type}">Catatan</label>
                        <textarea id="notes-${type}" rows="3"></textarea>
                    </div>
                    <div class="actions-group">
                        <button type="submit" class="btn btn-success">Simpan Transaksi</button>
                        <button type="button" class="btn btn-warning" onclick="app.resetForm('${type}')">Reset Form</button>
                    </div>
                </form>
            </div>`;
        }

        bindGlobalEvents() {
            this.cleanup();
            const globalController = new AbortController();
            this.eventControllers.set("global", globalController);
            const { signal } = globalController;

            document.addEventListener("click", (e) => {
                if (!e.target.closest(".filterable-dropdown")) {
                    this.closeAllDropdowns();
                }
            }, { signal });

            document.getElementById("saveConfigBtn")?.addEventListener("click", () => this.saveConfig(), { signal });
            document.getElementById("saveMasterItemsBtn")?.addEventListener("click", () => this.saveMasterItemsFromTextarea(), { signal });
            document.getElementById("clearMasterItemsBtn")?.addEventListener("click", () => this.clearMasterItems(), { signal });
            document.getElementById("backupDataBtn")?.addEventListener("click", () => this.backupData(), { signal });
            document.getElementById("restoreDataBtn")?.addEventListener("click", () => document.getElementById("restoreFileInput")?.click(), { signal });
            document.getElementById("restoreFileInput")?.addEventListener("change", (e) => this.restoreData(e), { signal });
            document.getElementById("exportCsvBtn")?.addEventListener("click", () => this.exportMasterItemsToCsv(), { signal });
            document.getElementById("importCsvBtn")?.addEventListener("click", () => document.getElementById("csvFileInput")?.click(), { signal });
            document.getElementById("csvFileInput")?.addEventListener("change", (e) => this.importMasterItemsFromCsv(e), { signal });
            document.getElementById("add-master-item-form-element")?.addEventListener("submit", (e) => {
                e.preventDefault();
                this.addNewMasterItem();
            }, { signal });

            const dashboardFilters = document.getElementById("dashboard-filters");
            if (dashboardFilters) {
                dashboardFilters.addEventListener("input", Utils.debounce(() => this.renderDashboard(), 300), { signal });
            }

            ["sale", "purchase", "delivery"].forEach((type) => {
                this.bindFormEvents(type);
                const historyContainer = document.getElementById(type === "sale" ? "penjualan" : type === "purchase" ? "pembelian" : "suratJalan");
                historyContainer?.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const dataKey = target.getAttribute('data-key');
                    if (target.id.startsWith('export-excel-btn-')) {
                        this.exportHistoryToExcel(dataKey);
                    } else if (target.id.startsWith('export-pdf-btn-')) {
                        this.exportHistoryToPdf(dataKey);
                    }
                });
            });
        }
        
        bindFormEvents(type) {
            const controller = new AbortController();
            this.eventControllers.set(`form-${type}`, controller);
            const { signal } = controller;

            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                this.saveTransaction(type);
            }, { signal });

            form.addEventListener("input", Utils.debounce(() => this.saveDraft(type), 1000), { signal });
            
            const partyType = type === 'sale' ? 'customer' : type === 'purchase' ? 'pemasok' : 'recipient';
            const partyInput = form.querySelector(`#${partyType}Name-${type}`);
            if (partyInput) {
                partyInput.addEventListener("input", Utils.debounce(() => this.filterPartyNames(type), 300), { signal });
                partyInput.addEventListener("focus", () => this.filterPartyNames(type, true), { signal });
                const dropdown = form.querySelector(`#party-dropdown-${type}`);
                if (dropdown) {
                    dropdown.addEventListener("click", (e) => {
                        const option = e.target.closest(".dropdown-option");
                        if (option) {
                            partyInput.value = option.textContent;
                            this.closeAllDropdowns();
                        }
                    }, { signal });
                }
            }

            const itemSelector = form.querySelector(`#item-selector-${type}`);
            const dropdownOptions = form.querySelector(`#dropdown-options-${type}`);

            itemSelector?.addEventListener("input", Utils.debounce(() => this.filterDropdown(type), 300), { signal });
            itemSelector?.addEventListener("focus", () => this.filterDropdown(type, true), { signal });
            itemSelector?.addEventListener("keydown", (e) => {
                if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                    e.preventDefault();
                    const options = dropdownOptions.querySelectorAll(".dropdown-option");
                    if (!options.length) return;
                    const current = dropdownOptions.querySelector(".dropdown-option.focused");
                    let index = current ? Array.from(options).indexOf(current) : -1;
                    if (e.key === "ArrowDown") {
                        index = (index + 1) % options.length;
                    } else if (e.key === "ArrowUp") {
                        index = (index - 1 + options.length) % options.length;
                    }
                    options.forEach(o => o.classList.remove("focused"));
                    if (index >= 0) {
                        options[index].classList.add("focused");
                        options[index].scrollIntoView({ block: "nearest" });
                    }
                } else if (e.key === "Enter" && dropdownOptions.style.display === "block") {
                    e.preventDefault();
                    const focused = dropdownOptions.querySelector(".dropdown-option.focused");
                    if (focused && focused.dataset.code) {
                        this.selectItemFromDropdown(focused.dataset.code, type);
                    }
                }
            }, { signal });

            dropdownOptions?.addEventListener("click", (e) => {
                const option = e.target.closest(".dropdown-option");
                if (option && option.dataset.code) {
                    this.selectItemFromDropdown(option.dataset.code, type);
                }
            }, { signal });

            form.querySelector(`#addItemBtn-${type}`)?.addEventListener("click", () => this.addItemToTempList(type), { signal });
            form.querySelector(`#temp-items-table-${type}`)?.addEventListener("click", (e) => {
                if (e.target.classList.contains("delete-temp-item-btn")) {
                    this.deleteItemFromTempList(parseInt(e.target.dataset.id, 10), type);
                }
            }, { signal });

            if (type !== "delivery") {
                ["itemPrice", "shippingCost", "discount"].forEach((id) => {
                    const input = form.querySelector(`#${id}-${type}`);
                    if (input) {
                        input.addEventListener("input", (e) => Utils.formatRupiahInput(e.target), { signal });
                        input.addEventListener("blur", () => this.calculateTotals(type), { signal });
                    }
                });
                form.querySelector(`#includePpn-${type}`)?.addEventListener("change", () => this.calculateTotals(type), { signal });
            }
        }

        selectItemFromDropdown(code, type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const item = this.data.masterItems.find((i) => i.code === code);
            if (!item) return;

            form.querySelector(`#item-selector-${type}`).value = item.name;
            form.querySelector(`#itemCode-${type}`).value = item.code;
            form.querySelector(`#itemUnit-${type}`).value = item.unit || "";
            if (type !== "delivery") {
                form.querySelector(`#itemPrice-${type}`).value = this.formatNumber(
                    item.price || 0
                );
            }
            form.querySelector(`#itemQty-${type}`).focus();
            this.closeAllDropdowns();
        }

        formatCurrency(value, withSymbol = true) {
            const number = Number(value) || 0;
            const options = {
                style: "currency",
                currency: "IDR",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            };
            if (!withSymbol) {
                return new Intl.NumberFormat("id-ID").format(number);
            }
            return new Intl.NumberFormat("id-ID", options).format(number);
        }

        formatNumber(value) {
            return new Intl.NumberFormat("id-ID").format(Number(value) || 0);
        }

        addItemToTempList(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const itemCode = form.querySelector(`#itemCode-${type}`).value;
            const qty = parseFloat(form.querySelector(`#itemQty-${type}`).value) || 0;
            const price =
                type !== "delivery"
                    ? parseInt(
                        form
                            .querySelector(`#itemPrice-${type}`)
                            .value.replace(/[^0-9]/g, ""),
                        10
                    ) || 0
                    : 0;
            const unit = form.querySelector(`#itemUnit-${type}`).value;

            const item = this.data.masterItems.find((i) => i.code === itemCode);
            if (!item) {
                this.showNotification("Kode barang tidak ditemukan.", false);
                return;
            }

            if (qty <= 0) {
                this.showNotification("Jumlah barang harus lebih dari 0.", false);
                return;
            }

            const newItem = {
                id: Date.now(),
                code: itemCode,
                name: item.name,
                qty,
                unit: unit || item.unit || "-",
                price,
                total: type !== "delivery" ? qty * price : 0,
            };

            this.tempItems[type].push(newItem);
            this.renderTempItemsTable(type);
            form.querySelector(`#item-selector-${type}`).value = "";
            form.querySelector(`#itemCode-${type}`).value = "";
            form.querySelector(`#itemQty-${type}`).value = "";
            if (type !== "delivery")
                form.querySelector(`#itemPrice-${type}`).value = "";
            form.querySelector(`#itemUnit-${type}`).value = "";
            form.querySelector(`#item-selector-${type}`).focus();
        }

        filterPartyNames(type, showAll = false) {
            const partyType = type === "sale" ? "customer" : type === "purchase" ? "pemasok" : "recipient";
            const input = document.getElementById(`${partyType}Name-${type}`);
            const filter = input?.value?.toUpperCase() || "";
            const dropdown = document.getElementById(`party-dropdown-${type}`);
            if (!dropdown || !input) return;

            this.closeAllDropdowns();
            this.activeDropdown = dropdown;

            const names = [...this.partyNames[partyType]].sort();
            const filteredNames = showAll ? names : names.filter(name => name.toUpperCase().includes(filter));
            
            dropdown.innerHTML = filteredNames.slice(0, 50)
                .map(name => `<div class="dropdown-option">${name}</div>`)
                .join("");
            
            dropdown.style.display = dropdown.innerHTML ? "block" : "none";
        }
        
        loadData() {
            const defaultData = {
                penjualan: [],
                pembelian: [],
                suratJalan: [],
                masterItems: [],
                config: {
                    noPenjualan: 1,
                    noPembelian: 1,
                    noSuratJalan: 1,
                    namaPerusahaan: "PT. SUMBER GANDA MEKAR",
                    alamatPerusahaan: "Jl. Raya Gedebage No. 95 Bandung",
                    kontak: "CP. Irwan : 082117800626, CP. Uwem : 082318188863",
                    rekening: "BANK BCA No. Rek. 2801011286 a.n Maman Suherman",
                    tagline: "JUAL BELI BESI TUA/BARU - RANGKA BETON/LOGAM - TIANG LISTRIK/TELP DAN KONSTRUKSI BAJA",
                    logoUrl: "logo.png",
                },
                partyNames: { customer: [], pemasok: [], recipient: [] },
            };

            return new Promise((resolve, reject) => {
                try {
                    const dataFromStorage = localStorage.getItem(this.STORAGE_KEY);
                    if (dataFromStorage) {
                        const parsedData = JSON.parse(dataFromStorage);
                        this.data = {
                            ...defaultData,
                            ...parsedData,
                            config: { ...defaultData.config, ...(parsedData.config || {}) },
                            partyNames: parsedData.partyNames || defaultData.partyNames,
                        };
                    } else {
                        this.data = defaultData;
                    }

                    this.partyNames.customer = new Set(this.data.partyNames.customer || []);
                    this.partyNames.pemasok = new Set(this.data.partyNames.pemasok || []);
                    this.partyNames.recipient = new Set(this.data.partyNames.recipient || []);

                    const trashData = localStorage.getItem(this.TRASH_KEY);
                    if (trashData) {
                        this.trash = JSON.parse(trashData);
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - 30);
                        this.trash = this.trash.filter(item => new Date(item.deletedAt) >= cutoff);
                        localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                    } else {
                        this.trash = [];
                    }

                    this.buildItemIndex();
                    resolve();
                } catch (e) {
                    this.data = defaultData;
                    this.trash = [];
                    this.buildItemIndex();
                    reject(e);
                }
            });
        }
        
        buildItemIndex() {
            this.itemIndex.clear();
            if (!this.data || !Array.isArray(this.data.masterItems)) return;
            this.data.masterItems.forEach(item => {
                if (item.code) this.itemIndex.set(item.code.toUpperCase(), item);
                if (item.name && !this.itemIndex.has(item.name.toUpperCase())) {
                    this.itemIndex.set(item.name.toUpperCase(), item);
                }
            });
        }

        async deleteTransaction(dataKey, id) {
            if (confirm(`Apakah Anda yakin ingin menghapus transaksi ID: ${id}? Transaksi akan dipindahkan ke Trash.`)) {
                try {
                    this.showLoading(true);
                    const index = this.data[dataKey].findIndex(item => item.id === id);
                    if (index > -1) {
                        const [transaction] = this.data[dataKey].splice(index, 1);
                        const trashedItem = { ...transaction, dataKey, deletedAt: new Date().toISOString() };
                        this.trash.unshift(trashedItem);
                        
                        localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                        this.saveData();
                        await this.updateAllUI();
                        
                        this.showNotification(`Transaksi ${id} dipindahkan ke Trash. <button class="btn btn-sm btn-warning" onclick="app.restoreTransaction('${dataKey}', '${trashedItem.id}', true)">Undo</button>`);
                    }
                } catch (error) {
                    Utils.logError("Transaction delete failed", error);
                    this.showNotification("Gagal menghapus transaksi", false);
                } finally {
                    this.showLoading(false);
                }
            }
        }

        generateTrashHTML() {
            return `<div class="form-section">
                  <h3 class="form-section-title">Trash (Item dihapus < 30 hari)</h3>
                  <div class="table-container">
                    <table class="data-table">
                        <thead>
                          <tr><th>Jenis</th><th>No. Transaksi</th><th>Tanggal</th><th>Nama</th><th>Dihapus Pada</th><th class="action-cell">Aksi</th></tr>
                        </thead>
                        <tbody id="trash-table"></tbody>
                    </table>
                  </div>
              </div>`;
        }

        renderTrashTable() {
            const tableBody = document.getElementById("trash-table");
            if (!tableBody) return;

            tableBody.innerHTML = this.trash.map(item => {
                const party = item.customer || item.pemasok || item.penerima || "N/A";
                const typeName = item.dataKey === "penjualan" ? "Penjualan" : item.dataKey === "pembelian" ? "Pembelian" : "Surat Jalan";
                return `<tr>
                    <td>${typeName}</td>
                    <td>${item.id}</td>
                    <td>${this.formatDate(item.tanggal)}</td>
                    <td>${party}</td>
                    <td>${this.formatDate(item.deletedAt)}</td>
                    <td class="action-cell">
                        <button class="btn btn-sm btn-success" onclick="app.restoreTransaction('${item.dataKey}', '${item.id}')">Pulihkan</button>
                        <button class="btn btn-sm btn-danger" onclick="app.permanentlyDeleteTransaction('${item.id}')">Hapus Permanen</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async restoreTransaction(dataKey, id, fromUndo = false) {
            const index = this.trash.findIndex(t => t.id === id && t.dataKey === dataKey);
            if (index === -1) {
                if(fromUndo) this.showNotification("Transaksi sudah dipulihkan.", false);
                return;
            };

            const [item] = this.trash.splice(index, 1);
            delete item.deletedAt;
            delete item.dataKey;

            this.data[dataKey].unshift(item);
            this.data[dataKey].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
            this.saveData();
            await this.updateAllUI();
            this.renderTrashTable();
            this.showNotification(`Transaksi ${id} berhasil dipulihkan.`);
        }

        permanentlyDeleteTransaction(id) {
            if (confirm(`Anda YAKIN ingin menghapus transaksi ${id} secara permanen? Tindakan ini tidak dapat dibatalkan.`)) {
                this.trash = this.trash.filter(t => t.id !== id);
                localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                this.renderTrashTable();
                this.showNotification(`Transaksi ${id} telah dihapus permanen.`);
            }
        }
        
        filterDropdown(type, showAll = false) {
          const input = document.getElementById(`item-selector-${type}`);
          const filter = input?.value?.toUpperCase() || "";
          const dropdown = document.getElementById(`dropdown-options-${type}`);
          if (!dropdown) return;

          this.closeAllDropdowns();
          this.activeDropdown = dropdown;
          
          const uniqueItems = new Map();
          if(this.itemIndex.has(filter)) {
              const item = this.itemIndex.get(filter);
              uniqueItems.set(item.code, item);
          }

          this.data.masterItems.forEach(item => {
              if (showAll || filter === "" || item.name.toUpperCase().includes(filter) || item.code.toUpperCase().includes(filter)) {
                  uniqueItems.set(item.code, item);
              }
          });

          const sortedItems = [...uniqueItems.values()].sort((a, b) => a.name.localeCompare(b.name));
          
          dropdown.innerHTML = sortedItems.slice(0, 50).map(item => 
              `<div class="dropdown-option" data-code="${item.code}">${item.name} <small>(${item.code})</small></div>`
          ).join('');
          
          dropdown.style.display = dropdown.innerHTML ? "block" : "none";
        }

        saveData() {
            try {
                this.data.partyNames.customer = [...this.partyNames.customer].sort();
                this.data.partyNames.pemasok = [...this.partyNames.pemasok].sort();
                this.data.partyNames.recipient = [...this.partyNames.recipient].sort();
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
            } catch (error) {
                Utils.logError("Failed to save data", error);
                this.showNotification("Gagal menyimpan data ke storage", false);
            }
        }

        closeAllDropdowns() {
            document.querySelectorAll(".dropdown-options").forEach((d) => (d.style.display = "none"));
            if (this.activeDropdown) {
                this.activeDropdown = null;
            }
        }

        saveDraft(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const draftData = {};
            form.querySelectorAll("input, select, textarea").forEach((input) => {
                if (input.id) {
                    draftData[input.id] = input.type === "checkbox" ? input.checked : input.value;
                }
            });

            const draft = {
                formData: draftData,
                tempItems: this.tempItems[type],
                expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            };

            this.draftForms[type] = draft;
            localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
        }

        loadDrafts() {
            try {
                const draftData = localStorage.getItem(this.DRAFT_KEY);
                if (!draftData) return;
                
                this.draftForms = JSON.parse(draftData);
                const now = new Date();

                Object.keys(this.draftForms).forEach((type) => {
                    const draft = this.draftForms[type];
                    if (!draft || !draft.formData || !Array.isArray(draft.tempItems) || new Date(draft.expires) <= now) {
                        delete this.draftForms[type];
                    } else if (draft.tempItems.length > 0 || Object.values(draft.formData).some(v => !!v)) {
                        if (confirm(`Ditemukan draft ${type} yang belum disimpan. Pulihkan?`)) {
                            this.restoreDraft(type);
                        } else {
                            delete this.draftForms[type];
                        }
                    } else {
                        delete this.draftForms[type];
                    }
                });
                localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
            } catch (error) {
                Utils.logError("Failed to load drafts", error);
                this.showNotification("Gagal memuat draft", false);
            }
        }

        restoreDraft(type) {
            const draft = this.draftForms[type];
            if (!draft) return;
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            Object.entries(draft.formData).forEach(([id, value]) => {
                const input = document.getElementById(id);
                if (input) {
                    if (input.type === "checkbox") input.checked = value;
                    else input.value = value;
                }
            });
            
            this.tempItems[type] = Array.isArray(draft.tempItems) ? draft.tempItems.filter(item => item && item.id && item.code && item.name) : [];
            this.renderTempItemsTable(type);
        }
        
        async updateAllUI() {
            try {
                this.showLoading(true);
                this.renderAllHistoryTables();
                await this.renderDashboard();
                await this.renderMasterItemsTextarea();
                this.updateMasterItemCountDisplay();
                this.loadConfigToForm();
                this.renderTrashTable();
            } catch (error) {
                Utils.logError("UI update failed", error);
                this.showNotification("Gagal memperbarui UI", false);
            } finally {
                this.showLoading(false);
            }
        }

        _getFilteredHistoryData(dataKey) {
            const type = dataKey === "penjualan" ? "sale" : dataKey === "pembelian" ? "purchase" : "delivery";
            const filters = document.getElementById(`history-filters-${type}`);
            const searchQuery = filters ? (filters.querySelector(".search-query")?.value || "").toUpperCase() : "";
            const startDate = filters ? filters.querySelector(".start-date")?.value : "";
            const endDate = filters ? filters.querySelector(".end-date")?.value : "";

            const filteredData = (this.data[dataKey] || []).filter(item => {
                const party = (item.customer || item.pemasok || item.penerima || "").toUpperCase();
                const idMatch = item.id.toUpperCase().includes(searchQuery);
                const partyMatch = party.includes(searchQuery);
                const dateMatch = (!startDate || item.tanggal >= startDate) && (!endDate || item.tanggal <= endDate);
                return (idMatch || partyMatch) && dateMatch;
            });
            return filteredData;
        }

        renderAllHistoryTables() {
            this.renderHistoryTable("penjualan", "sale-history-table");
            this.renderHistoryTable("pembelian", "purchase-history-table");
            this.renderHistoryTable("suratJalan", "delivery-history-table");
        }

        renderHistoryTable(dataKey, tableId, page = 1) {
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return;

            const type = dataKey === "penjualan" ? "sale" : dataKey === "pembelian" ? "purchase" : "delivery";
            const itemsPerPage = 25;

            const filteredData = this._getFilteredHistoryData(dataKey);

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            page = Math.min(Math.max(1, page), totalPages || 1);
            const startIndex = (page - 1) * itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

            tableBody.innerHTML = paginatedData.map(item => {
                const party = item.customer || item.pemasok || item.penerima || "N/A";
                const isTransaction = dataKey !== "suratJalan";
                return `<tr>
                    <td>${item.id}</td>
                    <td>${this.formatDate(item.tanggal)}</td>
                    <td>${party}<br><small>${item.telepon || ""}</small></td>
                    ${isTransaction ? `<td class="text-right">${this.formatCurrency(item.grandTotal)}</td>` : `<td>${item.noKendaraan || ""}</td>`}
                    <td class="action-cell">
                        ${dataKey !== 'suratJalan' ? `
                        <button class="btn btn-sm btn-info" onclick="app.printTransaction('${dataKey}', '${item.id}', 'faktur')">Faktur</button>
                        <button class="btn btn-sm btn-primary" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">SJ</button>
                        <button class="btn btn-sm btn-warning" onclick="app.printTransaction('${dataKey}', '${item.id}', 'kwitansi')">Kwitansi</button>
                        ` : `<button class="btn btn-sm btn-success" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">Cetak</button>`}
                        <button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${dataKey}', '${item.id}')">Hapus</button>
                    </td>
                </tr>`;
            }).join('');
            
            const paginationContainer = document.getElementById(`pagination-${type}`);
            if (paginationContainer) {
                paginationContainer.querySelector(`#page-info-${type}`).textContent = `Halaman ${page} dari ${totalPages}`;
                const prevButton = paginationContainer.querySelector(`#prev-${type}`);
                const nextButton = paginationContainer.querySelector(`#next-${type}`);
                prevButton.disabled = page === 1;
                nextButton.disabled = page >= totalPages;
                prevButton.onclick = () => this.renderHistoryTable(dataKey, tableId, page - 1);
                nextButton.onclick = () => this.renderHistoryTable(dataKey, tableId, page + 1);
            }
        }

        renderTempItemsTable(type) {
            const tableBody = document.querySelector(`#temp-items-table-${type} tbody`);
            if (!tableBody) return;
            const list = this.tempItems[type];
            
            tableBody.innerHTML = list.map((item, index) => {
                return `<tr>
                    <td>${index + 1}</td>
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td class="text-right">${this.formatNumber(item.qty)}</td>
                    <td>${item.unit}</td>
                    ${ type !== "delivery" ? `<td class="text-right">${this.formatCurrency(item.price)}</td><td class="text-right">${this.formatCurrency(item.total)}</td>` : "" }
                    <td class="action-cell"><button type="button" class="btn btn-sm btn-danger delete-temp-item-btn" data-id="${item.id}">X</button></td>
                </tr>`;
            }).join('');

            if (type !== "delivery") this.calculateTotals(type);
            this.saveDraft(type);
        }

        showNotification(message, isSuccess = true) {
            const notifArea = document.getElementById("notification-area");
            clearTimeout(this.notificationTimeout);

            notifArea.innerHTML = `${message} <button onclick="this.parentElement.style.display='none';">&times;</button>`;
            notifArea.className = `notification ${isSuccess ? "success" : "error"}`;
            notifArea.style.display = "block";
            window.scrollTo(0, 0);

            notifArea.querySelectorAll("button[onclick]").forEach(button => {
                const func = button.getAttribute('onclick');
                button.onclick = () => {
                    try { eval(func); } catch (e) { console.error("Error in notification button", e); }
                };
            });
            
            this.notificationTimeout = setTimeout(() => {
                notifArea.style.display = "none";
            }, 8000);
        }

        sanitizeInput(value) {
            if (typeof value !== 'string') return value;
            const div = document.createElement("div");
            div.textContent = value;
            return div.innerHTML;
        }

        calculateTotals(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form || type === 'delivery') return { subtotal: 0, ppn: 0, discount: 0, shippingCost: 0, grandTotal: 0 };

            const subtotal = this.tempItems[type].reduce((sum, item) => sum + (item.total || 0), 0);
            const discount = parseInt((form.querySelector(`#discount-${type}`)?.value || "0").replace(/[^0-9]/g, ""), 10) || 0;
            const shippingCost = parseInt((form.querySelector(`#shippingCost-${type}`)?.value || "0").replace(/[^0-9]/g, ""), 10) || 0;
            const includePpn = form.querySelector(`#includePpn-${type}`)?.checked;
            const ppn = includePpn ? Math.round((subtotal - discount) * 0.11) : 0;
            const grandTotal = subtotal - discount + shippingCost + ppn;

            form.querySelector(`#subtotal-${type}`).textContent = this.formatCurrency(subtotal);
            form.querySelector(`#ppn-${type}`).textContent = this.formatCurrency(ppn);
            form.querySelector(`#grandTotal-${type}`).textContent = this.formatCurrency(grandTotal);

            return { subtotal, ppn, discount, shippingCost, grandTotal };
        }

        generateId(type) {
            let num, prefix, configKey;
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, "0");

            switch (type) {
                case "sale": num = this.data.config.noPenjualan; prefix = "PJ"; configKey = "noPenjualan"; break;
                case "purchase": num = this.data.config.noPembelian; prefix = "PB"; configKey = "noPembelian"; break;
                case "delivery": num = this.data.config.noSuratJalan; prefix = "SJ"; configKey = "noSuratJalan"; break;
            }
            const id = `${prefix}${year}${month}-${String(num).padStart(4, "0")}`;
            const dataKey = type === "sale" ? "penjualan" : type === "purchase" ? "pembelian" : "suratJalan";
            
            if (this.data[dataKey].some(t => t.id === id)) {
                this.data.config[configKey]++;
                return this.generateId(type);
            }
            return id;
        }

        async saveTransaction(type) {
            try {
                this.showLoading(true);
                const form = document.getElementById(`${type}Form`);
                const dataKey = type === "sale" ? "penjualan" : type === "purchase" ? "pembelian" : "suratJalan";
                const tempItems = this.tempItems[type];

                if (tempItems.length === 0) throw new Error("Tambahkan minimal satu barang.");
                for (const field of form.querySelectorAll("[required], [pattern]")) {
                    const label = field.labels?.[0]?.textContent || field.name;
                    if (!Utils.validateInput(field.value, "required")) { field.focus(); throw new Error(`Field '${label}' harus diisi.`); }
                    if (field.pattern && !new RegExp(field.pattern).test(field.value)) { field.focus(); throw new Error(`Isian untuk '${label}' tidak valid.`); }
                }

                const partyType = type === "sale" ? "customer" : type === "purchase" ? "pemasok" : "recipient";
                const phoneInput = form.querySelector(`#${partyType}Phone-${type}`);
                if (phoneInput && phoneInput.value && !Utils.validateInput(phoneInput.value, "phone")) { phoneInput.focus(); throw new Error("Nomor telepon tidak valid."); }

                const partyName = this.sanitizeInput(form.querySelector(`#${partyType}Name-${type}`).value.trim());
                if (partyName) this.partyNames[partyType].add(partyName);

                const newId = this.generateId(type);
                const isTransaction = type === "sale" || type === "purchase";
                const newTrans = {
                    id: newId,
                    tanggal: form.querySelector(`#${isTransaction ? "invoiceDate" : "deliveryDate"}-${type}`).value,
                    notes: this.sanitizeInput(form.querySelector(`#notes-${type}`).value),
                    items: [...tempItems],
                };

                if (isTransaction) {
                    const totals = this.calculateTotals(type);
                    Object.assign(newTrans, {
                        ...totals,
                        [type === "sale" ? "customer" : "pemasok"]: partyName,
                        alamat: this.sanitizeInput(form.querySelector(`#${partyType}Address-${type}`).value),
                        telepon: this.sanitizeInput(form.querySelector(`#${partyType}Phone-${type}`).value),
                        noKendaraan: this.sanitizeInput(form.querySelector(`#vehicleNo-${type}`)?.value),
                        metodePembayaran: form.querySelector(`#paymentMethod-${type}`).value,
                    });
                    if (type === "sale") {
                        newTrans.ref = this.sanitizeInput(form.querySelector(`#ref-${type}`).value);
                        this.data.config.noPenjualan++;
                    } else {
                        this.data.config.noPembelian++;
                    }
                } else {
                    Object.assign(newTrans, {
                        penerima: partyName,
                        alamat: this.sanitizeInput(form.querySelector(`#recipientAddress-${type}`).value),
                        telepon: this.sanitizeInput(form.querySelector(`#recipientPhone-${type}`).value),
                        noKendaraan: this.sanitizeInput(form.querySelector(`#vehicleNo-${type}`).value),
                    });
                    this.data.config.noSuratJalan++;
                }

                this.data[dataKey].unshift(newTrans);
                this.saveData();
                this.resetForm(type);
                await this.updateAllUI();
                this.showNotification(`Transaksi ${newTrans.id} berhasil disimpan.`);
            } catch (error) {
                Utils.logError("Transaction save failed", error);
                this.showNotification(`Gagal: ${error.message}`, false);
            } finally {
                this.showLoading(false);
            }
        }

        resetForm(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;
            form.reset();
            this.tempItems[type] = [];
            this.renderTempItemsTable(type);
            const isTransaction = type === "sale" || type === "purchase";
            const dateInput = form.querySelector(`#${isTransaction ? "invoiceDate" : "deliveryDate"}-${type}`);
            if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);
            form.querySelector(`#transNo-${type}`).value = this.generateId(type);
            this.draftForms[type] = null;
            localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
        }

        generateHistoryHTML(type) {
            const title = type === 'sale' ? 'Penjualan' : type === 'purchase' ? 'Pembelian' : 'Surat Jalan';
            const tableId = `${type}-history-table`;
            const partyHeader = type === 'sale' ? 'Customer' : type === 'purchase' ? 'Pemasok' : 'Penerima';
            const dataKey = type === 'sale' ? 'penjualan' : type === 'purchase' ? 'pembelian' : 'suratJalan';

            const headers = `<th>No. Transaksi</th><th>Tanggal</th><th>${partyHeader} & Kontak</th>${type !== 'delivery' ? '<th class="text-right">Total</th>' : '<th>No. Kendaraan</th>'}<th class="action-cell">Aksi</th>`;

            return `<div class="form-section" style="margin-top: 40px;">
                  <h3 class="form-section-title">Riwayat Transaksi ${title}</h3>
                  <div class="history-filters" id="history-filters-${type}">
                      <div class="form-group"><label>Cari (ID, Nama)</label><input type="text" class="search-query" placeholder="Ketik untuk mencari..."></div>
                      <div class="form-group"><label>Dari Tanggal</label><input type="date" class="start-date"></div>
                      <div class="form-group"><label>Sampai Tanggal</label><input type="date" class="end-date"></div>
                  </div>
                  <div class="actions-group" style="margin-bottom: 10px; justify-content: flex-start;">
                    <button class="btn btn-success" onclick="app.exportHistoryToCsv('${dataKey}')">Export CSV</button>
                    <button class="btn btn-danger" id="export-pdf-btn-${type}" data-key="${dataKey}">Export PDF</button>
                    <button class="btn btn-primary" id="export-excel-btn-${type}" data-key="${dataKey}">Export Excel</button>
                  </div>
                  <div class="table-container">
                      <table class="data-table">
                          <thead><tr>${headers}</tr></thead>
                          <tbody id="${tableId}"></tbody>
                      </table>
                  </div>
                  <div class="actions-group" id="pagination-${type}" style="justify-content: center;">
                      <button class="btn btn-primary" id="prev-${type}" disabled>&laquo; Sebelumnya</button>
                      <span id="page-info-${type}" style="align-self: center; margin: 0 15px;">Halaman 1 dari 1</span>
                      <button class="btn btn-primary" id="next-${type}" disabled>Berikutnya &raquo;</button>
                  </div>
              </div>`;
        }

        exportHistoryToCsv(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const headers = ["No. Transaksi", "Tanggal", "Customer/Pemasok/Penerima", "Alamat", "Telepon", "No. Kendaraan", "Metode Pembayaran", "Catatan", "Subtotal", "Diskon", "PPN", "Ongkir", "Grand Total", "Kode Barang", "Nama Barang", "Jumlah", "Satuan", "Harga Satuan", "Total Barang"];
            const csvRows = [headers.join(",")];
            
            transactions.forEach(t => {
                t.items.forEach(item => {
                    const row = [
                        `"${t.id}"`, `"${t.tanggal}"`, `"${t.customer || t.pemasok || t.penerima || ''}"`,
                        `"${t.alamat || ''}"`, `"${t.telepon || ''}"`, `"${t.noKendaraan || ''}"`, `"${t.metodePembayaran || ''}"`,
                        `"${(t.notes || '').replace(/"/g, '""')}"`, t.subtotal ?? 0, t.discount ?? 0, t.ppn ?? 0, t.shippingCost ?? 0, t.grandTotal ?? 0,
                        `"${item.code}"`, `"${(item.name || '').replace(/"/g, '""')}"`, item.qty, `"${item.unit}"`, item.price ?? 0, item.total ?? 0
                    ];
                    csvRows.push(row.join(','));
                });
            });

            const csvString = csvRows.join("\n");
            const blob = new Blob([`\uFEFF${csvString}`], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `riwayat_${dataKey}_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke CSV.");
        }
        
        exportHistoryToExcel(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const flattenedData = [];
            transactions.forEach(t => {
                const partner = t.customer || t.pemasok || t.penerima || '';
                if (t.items.length === 0) {
                     flattenedData.push({
                        'No Transaksi': t.id, 'Tanggal': t.tanggal, 'Partner': partner, 'No Kendaraan': t.noKendaraan,
                        'Metode Bayar': t.metodePembayaran, 'Subtotal': t.subtotal, 'Diskon': t.discount, 'PPN': t.ppn,
                        'Ongkir': t.shippingCost, 'Grand Total': t.grandTotal,
                        'Kode Barang': '', 'Nama Barang': '(No items)', 'Jumlah': '', 'Satuan': '', 'Harga Satuan': '', 'Total Barang': ''
                    });
                } else {
                    t.items.forEach(item => {
                        flattenedData.push({
                            'No Transaksi': t.id, 'Tanggal': t.tanggal, 'Partner': partner, 'No Kendaraan': t.noKendaraan,
                            'Metode Bayar': t.metodePembayaran, 'Subtotal': t.subtotal, 'Diskon': t.discount, 'PPN': t.ppn,
                            'Ongkir': t.shippingCost, 'Grand Total': t.grandTotal,
                            'Kode Barang': item.code, 'Nama Barang': item.name, 'Jumlah': item.qty, 'Satuan': item.unit,
                            'Harga Satuan': item.price, 'Total Barang': item.total
                        });
                    });
                }
            });

            const worksheet = XLSX.utils.json_to_sheet(flattenedData);
            worksheet['!cols'] = [
                { wch: 15 }, { wch: 12 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, 
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 15 }
            ];
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan');
            XLSX.writeFile(workbook, `Laporan_${dataKey}_${new Date().toISOString().slice(0, 10)}.xlsx`);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke Excel.");
        }

        exportHistoryToPdf(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            const head = [['ID', 'Tanggal', 'Partner', 'No. Kend', 'Item', 'Qty', 'Harga', 'Total']];
            const body = [];
            transactions.forEach(t => {
                t.items.forEach(item => {
                    body.push([
                        t.id, t.tanggal, t.customer || t.pemasok || t.penerima || '', t.noKendaraan || '-',
                        item.name, this.formatNumber(item.qty), this.formatCurrency(item.price, false), this.formatCurrency(item.total, false)
                    ]);
                });
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                headStyles: { fillColor: [0, 48, 135] },
                didDrawPage: (data) => {
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Laporan ${dataKey.charAt(0).toUpperCase() + dataKey.slice(1)}`, data.settings.margin.left, 15);
                    const today = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                    doc.setFontSize(10);
                    doc.text(`Dicetak pada: ${today}`, doc.internal.pageSize.getWidth() - data.settings.margin.right, 15, { align: 'right' });
                },
            });

            doc.save(`Laporan_${dataKey}_${new Date().toISOString().slice(0, 10)}.pdf`);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke PDF.");
        }
        
        generateDashboardHTML() {
            return `<div class="form-section">
                  <h3 class="form-section-title">Statistik</h3>
                  <div class="history-filters" id="dashboard-filters">
                      <div class="form-group"><label for="dashboard-start-date">Dari Tanggal</label><input type="date" class="start-date" id="dashboard-start-date"></div>
                      <div class="form-group"><label for="dashboard-end-date">Sampai Tanggal</label><input type="date" class="end-date" id="dashboard-end-date"></div>
                  </div>
                  <div class="stat-cards" id="dashboard-stats"></div>
              </div>
              <div class="form-section">
                  <h3 class="form-section-title">Ringkasan Transaksi Terbaru</h3>
                  <div class="table-container">
                      <table class="data-table" id="dashboard-transactions-table">
                          <thead>
                              <tr><th>Jenis</th><th>No. Transaksi</th><th>Tanggal</th><th>Nama</th><th class="text-right">Total</th><th class="action-cell">Aksi</th></tr>
                          </thead>
                          <tbody></tbody>
                      </table>
                  </div>
              </div>`;
        }

        generateAddItemFormHTML() {
            return `<form id="add-master-item-form-element">
                  <div class="form-grid" style="align-items: flex-end;">
                      <div class="form-group"><label for="newItemCode">Kode Barang</label><input type="text" id="newItemCode" required pattern="[A-Za-z0-9-]{1,20}"></div>
                      <div class="form-group"><label for="newItemName">Nama Barang</label><input type="text" id="newItemName" required maxlength="100"></div>
                      <div class="form-group"><label for="newItemUnit">Satuan</label><input type="text" id="newItemUnit" placeholder="e.g., kg, unit, m"></div>
                      <div class="form-group"><label for="newItemPrice">Harga Jual Default</label><input type="text" id="newItemPrice" class="rupiah-input" value="0"></div>
                      <div class="form-group"><button type="submit" class="btn btn-primary">Tambah ke Master</button></div>
                  </div>
              </form>`;
        }
        
        generatePrintHTML(transaction, template) {
            const config = this.data.config;
            const isTransaction = transaction.grandTotal !== undefined;
            const partyName = transaction.customer || transaction.pemasok || transaction.penerima || 'N/A';
            const title = template === "faktur" ? `FAKTUR ${transaction.customer ? "PENJUALAN" : "PEMBELIAN"}` : template === "kwitansi" ? "KWITANSI PEMBAYARAN" : "SURAT JALAN";
            const grandTotalInteger = Math.floor(transaction.grandTotal || 0);

            let metaContent = `<table class="meta-table">
                <tr><td style="width:120px;">Kepada Yth.</td><td>: ${partyName}</td></tr>
                <tr><td>Alamat</td><td>: ${transaction.alamat || "-"}</td></tr>
                ${transaction.telepon ? `<tr><td>Telepon</td><td>: ${transaction.telepon}</td></tr>` : ""}
            </table>
            <table class="meta-table" style="float:right; width: 45%; margin-top:-65px;">
                <tr><td width="100">No. ${template === "faktur" ? "Faktur" : "Surat Jalan"}</td><td>: ${transaction.id || 'N/A'}</td></tr>
                <tr><td>Tanggal</td><td>: ${this.formatDate(transaction.tanggal)}</td></tr>
                ${isTransaction && transaction.ref ? `<tr><td>Ref</td><td>: ${transaction.ref}</td></tr>` : ""}
                ${transaction.noKendaraan ? `<tr><td>No. Kendaraan</td><td>: ${transaction.noKendaraan}</td></tr>` : ""}
            </table><div style="clear:both;"></div>`;

            if (template === "kwitansi") {
                metaContent = `<table class="meta-table">
                    <tr><td width="150">Sudah terima dari</td><td>: ${partyName}</td></tr>
                    <tr><td>Uang Sejumlah</td><td>: <b>${this.formatCurrency(transaction.grandTotal || 0)}</b></td></tr>
                    <tr><td style="vertical-align:baseline;">Terbilang</td><td style="vertical-align:baseline; font-style:italic; text-transform: capitalize;">: ${this.terbilang(grandTotalInteger)} rupiah</td></tr>
                    <tr><td style="vertical-align:baseline;">Untuk Pembayaran</td><td style="vertical-align:baseline;">: Pelunasan Faktur No. ${transaction.id || "N/A"}</td></tr>
                    ${transaction.metodePembayaran ? `<tr><td>Metode Pembayaran</td><td>: ${transaction.metodePembayaran}</td></tr>` : ""}
                </table>`;
            }

            const itemsContent = template !== "kwitansi" ? `<table class="items-table">
                <thead><tr><th style="width:5%;">No</th><th style="width:40%;">Nama Barang</th><th style="width:10%; text-align:right;">Qty</th><th style="width:10%; text-align:center;">Satuan</th>
                ${isTransaction ? `<th style="width:15%; text-align:right;">Harga Satuan</th><th style="width:20%; text-align:right;">Jumlah</th>` : ""}
                </tr></thead><tbody>
                ${(transaction.items || []).map((item, i) => `<tr>
                    <td style="text-align:center;">${i + 1}</td>
                    <td>${item.name} ${item.code ? `<small>(${item.code})</small>` : ""}</td>
                    <td style="text-align:right;">${this.formatNumber(item.qty)}</td>
                    <td style="text-align:center;">${item.unit || "-"}</td>
                    ${isTransaction ? `<td style="text-align:right;">${this.formatNumber(item.price || 0)}</td><td style="text-align:right;">${this.formatNumber(item.total || 0)}</td>` : ""}
                </tr>`).join("")}</tbody></table>` : "";
            
            const summaryContent = isTransaction && template === "faktur" ? `<table class="summary-table">
                <tr><td>Subtotal</td><td style="text-align:right;">${this.formatNumber(transaction.subtotal || 0)}</td></tr>
                ${(transaction.discount || 0) > 0 ? `<tr><td>Diskon</td><td style="text-align:right;">-${this.formatNumber(transaction.discount)}</td></tr>` : ""}
                ${(transaction.ppn || 0) > 0 ? `<tr><td>PPN 11%</td><td style="text-align:right;">${this.formatNumber(transaction.ppn)}</td></tr>` : ""}
                ${(transaction.shippingCost || 0) > 0 ? `<tr><td>Ongkos Kirim</td><td style="text-align:right;">${this.formatNumber(transaction.shippingCost)}</td></tr>` : ""}
                <tr style="border-top: 1px solid black; font-weight:bold;"><td>Total</td><td style="text-align:right;">${this.formatNumber(transaction.grandTotal || 0)}</td></tr>
            </table><div style="clear:both;"></div>
            <div style="margin-top: 10px; font-style:italic; text-transform: capitalize;">Terbilang: ${this.terbilang(grandTotalInteger)} rupiah</div>` : "";

            const signatures = template === "surat_jalan" ? `<div class="print-signatures">
                <div><p>Pengirim,</p><div class="signature-space"></div><p>(${"_".repeat(20)})</p></div>
                <div><p>Gudang,</p><div class="signature-space"></div><p>(${"_".repeat(20)})</p></div>
                <div><p>Penerima,</p><div class="signature-space"></div><p>(${"_".repeat(20)})</p></div></div>` :
                template === "kwitansi" ? `<div class="print-signatures" style="justify-content:flex-end;">
                <div><p>Bandung, ${this.formatDate(new Date())}</p><p>Penerima,</p><div class="signature-space"></div><p>(${config.namaPerusahaan})</p></div></div>` :
                `<div class="print-signatures">
                <div><p>Penerima,</p><div class="signature-space"></div><p>(${"_".repeat(20)})</p></div>
                <div><p>Hormat Kami,</p><div class="signature-space"></div><p>(${config.namaPerusahaan})</p></div></div>`;
            
            return `<div class="page printable-content"><div class="print-header">
                    <div class="company-info"><h3>${config.namaPerusahaan}</h3><p>${config.tagline}</p><p>${config.alamatPerusahaan}</p><p>${config.kontak}</p></div>
                    <img src="${config.logoUrl || 'https://via.placeholder.com/150x50.png?text=Logo'}" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/150x50.png?text=Logo';">
                </div><div class="print-section ${template === 'kwitansi' ? 'kwitansi' : ''}">
                    <h4 style="text-decoration: underline; text-align:center; margin-bottom: 5mm;">${title}</h4>
                    ${metaContent}${itemsContent}${summaryContent}
                    ${transaction.notes ? `<div style="border-top: 1px solid #ccc; margin-top: 5mm; padding-top: 5mm;"><p><b>Keterangan:</b> ${transaction.notes}</p></div>` : ""}
                </div><div class="print-footer">
                    ${isTransaction && template === "faktur" ? `<p style="font-size:8pt; text-align:center;">Pembayaran mohon di transfer ke rekening ${config.rekening}</p>` : ""}
                    ${signatures}</div></div>`;
        }

        async renderDashboard() {
            const statsContainer = document.getElementById("dashboard-stats");
            const tableBody = document.querySelector("#dashboard-transactions-table tbody");
            if (!statsContainer || !tableBody) return;

            const filters = document.getElementById("dashboard-filters");
            const startDate = filters.querySelector(".start-date")?.value;
            const endDate = filters.querySelector(".end-date")?.value;
            const filterPredicate = t => (!startDate || t.tanggal >= startDate) && (!endDate || t.tanggal <= endDate);

            const filteredSales = this.data.penjualan.filter(filterPredicate);
            const filteredPurchases = this.data.pembelian.filter(filterPredicate);
            const totalSales = filteredSales.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
            const totalPurchases = filteredPurchases.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
            const profit = totalSales - totalPurchases;
            const allTransactions = [
                ...this.data.penjualan.map((t) => ({ ...t, type: "Penjualan", dataKey: "penjualan" })),
                ...this.data.pembelian.map((t) => ({ ...t, type: "Pembelian", dataKey: "pembelian" })),
                ...this.data.suratJalan.map((t) => ({ ...t, type: "Surat Jalan", dataKey: "suratJalan" })),
            ].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            statsContainer.innerHTML = `<div class="stat-card">
                <div class="stat-card-title">Total Penjualan (Filtered)</div><div class="stat-card-value profit">${this.formatCurrency(totalSales)}</div>
            </div><div class="stat-card">
                <div class="stat-card-title">Total Pembelian (Filtered)</div><div class="stat-card-value loss">${this.formatCurrency(totalPurchases)}</div>
            </div><div class="stat-card">
                <div class="stat-card-title">Laba Kotor (Filtered)</div><div class="stat-card-value ${profit >= 0 ? "profit" : "loss"}">${this.formatCurrency(profit)}</div>
            </div><div class="stat-card">
                <div class="stat-card-title">Jumlah Transaksi (Total)</div><div class="stat-card-value">${this.formatNumber(allTransactions.length)}</div>
            </div>`;

            tableBody.innerHTML = allTransactions.slice(0, 50).map(t => {
                const party = t.customer || t.pemasok || t.penerima || "N/A";
                return `<tr>
                    <td><span class="btn btn-sm ${t.dataKey === 'penjualan' ? 'btn-success' : t.dataKey === 'pembelian' ? 'btn-danger' : 'btn-info'}">${t.type}</span></td>
                    <td>${t.id}</td><td>${this.formatDate(t.tanggal)}</td><td>${party}</td>
                    <td class="text-right">${t.grandTotal !== undefined ? this.formatCurrency(t.grandTotal) : "-"}</td>
                    <td class="action-cell">
                        <button class="btn btn-sm btn-info" onclick="app.printTransaction('${t.dataKey}', '${t.id}', '${t.dataKey !== 'suratJalan' ? 'faktur' : 'surat_jalan'}')">Cetak</button>
                        <button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${t.dataKey}', '${t.id}')">Hapus</button>
                    </td></tr>`;
            }).join('');
        }
        
        terbilang(nilai) {
            nilai = Math.floor(Math.abs(nilai));
            const bilangan = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
            if (nilai === 0) return "nol";
            if (nilai < 12) return bilangan[nilai].trim();
            if (nilai < 20) return this.terbilang(nilai - 10) + " belas";
            if (nilai < 100) return (this.terbilang(Math.floor(nilai / 10)) + " puluh " + this.terbilang(nilai % 10)).trim();
            if (nilai < 200) return ("seratus " + this.terbilang(nilai - 100)).trim();
            if (nilai < 1000) return (this.terbilang(Math.floor(nilai / 100)) + " ratus " + this.terbilang(nilai % 100)).trim();
            if (nilai < 2000) return ("seribu " + this.terbilang(nilai - 1000)).trim();
            if (nilai < 1000000) return (this.terbilang(Math.floor(nilai / 1000)) + " ribu " + this.terbilang(nilai % 1000)).trim();
            if (nilai < 1000000000) return (this.terbilang(Math.floor(nilai / 1000000)) + " juta " + this.terbilang(nilai % 1000000)).trim();
            if (nilai < 1000000000000) return (this.terbilang(Math.floor(nilai / 1000000000)) + " milyar " + this.terbilang(nilai % 1000000000)).trim();
            if (nilai < 1000000000000000) return (this.terbilang(Math.floor(nilai / 1000000000000)) + " triliun " + this.terbilang(nilai % 1000000000000)).trim();
            return "";
        }

        formatDate(dateString) {
            try {
                if (!dateString) return "-";
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    const parts = dateString.split(/[-T]/);
                    return new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" });
                }
                return date.toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" });
            } catch (error) {
                return dateString;
            }
        }

        deleteItemFromTempList(id, type) {
            this.tempItems[type] = this.tempItems[type].filter((item) => item.id !== id);
            this.renderTempItemsTable(type);
        }

        async renderMasterItemsTextarea() {
            const textarea = document.getElementById("masterItemJson");
            if (textarea) textarea.value = JSON.stringify(this.data.masterItems, null, 2);
        }

        updateMasterItemCountDisplay() {
            const countSpan = document.getElementById("master-item-count");
            if (countSpan) countSpan.textContent = this.data.masterItems.length;
        }

        loadConfigToForm() {
            const config = this.data.config;
            Object.keys(config).forEach(key => {
                const input = document.getElementById(`config-${key}`);
                if (input) input.value = config[key];
            });
            document.getElementById("header-title").textContent = config.namaPerusahaan || "Sistem Akuntansi";
            document.getElementById("header-tagline").textContent = config.tagline || "Pencatatan Penjualan dan Pembelian";
            document.getElementById("header-logo").src = config.logoUrl || "https://via.placeholder.com/150x50.png?text=Logo";
        }

        saveConfig() {
            Object.keys(this.data.config).forEach(key => {
                const input = document.getElementById(`config-${key}`);
                if (input) this.data.config[key] = input.value;
            });
            this.saveData();
            this.loadConfigToForm();
            this.showNotification("Informasi perusahaan berhasil disimpan.");
        }

        saveMasterItemsFromTextarea() {
            const textarea = document.getElementById("masterItemJson");
            try {
                const items = JSON.parse(textarea.value);
                if (!Array.isArray(items)) throw new Error("Format JSON harus berupa array.");
                if (!items.every(item => item.hasOwnProperty("code") && item.hasOwnProperty("name"))) throw new Error('Setiap item harus memiliki properti "code" dan "name".');
                this.data.masterItems = items;
                this.buildItemIndex();
                this.saveData();
                this.updateMasterItemCountDisplay();
                this.showNotification("Data master barang berhasil disimpan dari JSON.");
            } catch (error) {
                Utils.logError("Failed to save master items from JSON", error);
                this.showNotification(`Gagal menyimpan: ${error.message}`, false);
            }
        }

        clearMasterItems() {
            if (confirm("Yakin ingin menghapus SEMUA data master barang?")) {
                this.data.masterItems = [];
                this.buildItemIndex();
                this.saveData();
                this.updateAllUI();
                this.showNotification("Semua data master barang telah dihapus.");
            }
        }

        backupData() {
            const dataStr = JSON.stringify(this.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup_akuntansi_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            this.showNotification("Backup data berhasil diunduh.");
        }

        restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    if (restoredData.config && restoredData.penjualan && restoredData.pembelian) {
                        if (confirm("Yakin ingin memulihkan data? Data saat ini akan ditimpa.")) {
                            this.data = restoredData;
                            this.saveData();
                            await this.init();
                            this.showNotification("Data berhasil dipulihkan. Halaman akan dimuat ulang.");
                            setTimeout(() => window.location.reload(), 1500);
                        }
                    } else {
                        throw new Error("File backup tidak valid.");
                    }
                } catch (err) {
                    Utils.logError("Restore failed", err);
                    this.showNotification(`Gagal memulihkan: ${err.message}`, false);
                } finally {
                    event.target.value = "";
                }
            };
            reader.readAsText(file);
        }

        exportMasterItemsToCsv() {
            if (this.data.masterItems.length === 0) {
                this.showNotification("Tidak ada data barang untuk diekspor.", false);
                return;
            }
            const headers = ["code", "name", "unit", "price"];
            const csvRows = [headers.join(","), ...this.data.masterItems.map((item) => headers.map((header) => `"${(item[header] || "").toString().replace(/"/g, '""')}"`).join(","))];
            const csvString = csvRows.join("\n");
            const blob = new Blob([`\uFEFF${csvString}`], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "master_barang.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        importMasterItemsFromCsv(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const lines = e.target.result.split(/\r\n|\n/).filter(line => line.trim());
                    if (lines.length <= 1) throw new Error("File CSV kosong atau tidak valid.");
                    const splitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                    const headers = lines[0].split(splitRegex).map(h => h.trim().replace(/"/g, ""));
                    if (!headers.includes("code") || !headers.includes("name")) throw new Error('CSV harus memiliki kolom "code" dan "name".');
                    const newItems = lines.slice(1).map(line => {
                        const values = line.split(splitRegex).map(v => v.trim().replace(/"/g, ""));
                        const item = {};
                        headers.forEach((header, index) => { item[header] = header === "price" ? (parseInt(values[index]) || 0) : (values[index] || ""); });
                        return item;
                    }).filter(item => item.code && item.name);
                    if (newItems.length === 0) throw new Error("Tidak ada data valid untuk diimpor.");
                    if (confirm(`Ditemukan ${newItems.length} barang dari CSV. Timpa data yang ada?`)) {
                        this.data.masterItems = newItems;
                        this.buildItemIndex();
                        this.saveData();
                        this.updateAllUI();
                        this.showNotification("Data barang berhasil diimpor.");
                    }
                } catch (err) {
                    Utils.logError("CSV Import failed", err);
                    this.showNotification(`Gagal mengimpor: ${err.message}`, false);
                } finally {
                    event.target.value = "";
                }
            };
            reader.readAsText(file);
        }

        addNewMasterItem() {
            const code = document.getElementById("newItemCode").value.trim();
            const name = document.getElementById("newItemName").value.trim();
            const unit = document.getElementById("newItemUnit").value.trim();
            const price = parseInt(document.getElementById("newItemPrice").value.replace(/[^0-9]/g, ""), 10) || 0;

            if (!code || !name) { this.showNotification("Kode dan Nama Barang harus diisi.", false); return; }
            if (!/^[A-Za-z0-9-]{1,20}$/.test(code)) { this.showNotification("Kode hanya boleh berisi huruf, angka, dan hubung (-), maks 20 karakter.", false); return; }
            if (this.data.masterItems.some((item) => item.code.toUpperCase() === code.toUpperCase())) { this.showNotification(`Kode barang '${code}' sudah ada.`, false); return; }

            this.data.masterItems.unshift({ code, name, unit, price: price || 0 });
            this.buildItemIndex();
            this.saveData();
            this.renderMasterItemsTextarea();
            this.updateMasterItemCountDisplay();
            this.showNotification(`Barang '${name}' berhasil ditambahkan.`);
            document.getElementById("add-master-item-form-element").reset();
        }

        printTransaction(dataKey, id, template) {
            const transaction = this.data[dataKey].find((t) => t.id === id);
            if (!transaction) { this.showNotification("Transaksi tidak ditemukan.", false); return; }
            const printHTML = this.generatePrintHTML(transaction, template);
            
            let modal = document.getElementById("print-preview-modal");
            if (modal) modal.remove();
            modal = document.createElement("div");
            modal.id = "print-preview-modal";
            modal.innerHTML = `<div class="modal-content">
                    <h3 class="form-section-title">Print Preview</h3>
                    <div class="modal-body">${printHTML}</div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelPrintBtn">Batal</button>
                        <button class="btn btn-primary" id="confirmPrintBtn">Cetak</button>
                    </div></div>`;
            document.body.appendChild(modal);
            document.getElementById("cancelPrintBtn").onclick = () => modal.remove();
            document.getElementById("confirmPrintBtn").onclick = () => {
                const printArea = document.getElementById("print-area");
                printArea.innerHTML = printHTML;
                window.print();
                printArea.innerHTML = "";
                modal.remove();
            };
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        window.app = new SistemAkuntansi();
        window.app.init();
        const tabs = document.querySelectorAll(".nav-tab");
        const tabContents = document.querySelectorAll(".tab-content");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));
            tab.classList.add("active");
            const activeContent = document.getElementById(tab.dataset.tab);
            if (activeContent) activeContent.classList.add("active");
            if (tab.dataset.tab === "dashboard") window.app.renderDashboard();
            if (tab.dataset.tab === "pengaturan") window.app.renderTrashTable();
          });
        });
      });
    </script>
</body>
</html>